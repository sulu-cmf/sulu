define(["services/sulumedia/collection-manager"],function(a){"use strict";var b="sulu.collection-edit.",c={instanceName:""},d={editFormSelector:"#collection-settings"},e=function(){return g.call(this,"closed")},f=function(){return g.call(this,"initialized")},g=function(a){return b+(this.options.instanceName?this.options.instanceName+".":"")+a};return{templates:["/admin/media/template/collection/settings"],initialize:function(){if(this.options=this.sandbox.util.extend(!0,{locale:this.sandbox.sulu.getDefaultContentLocale()},c,this.options),!this.options.collectionId)throw new Error("collection-id is not defined");this.bindEvents(),a.loadOrNew(this.options.collectionId,this.options.locale).then(function(a){this.data=a,this.openOverlay()}.bind(this)),this.sandbox.emit(f.call(this))},bindEvents:function(){this.sandbox.once("husky.overlay.edit-collection.opened",function(){this.sandbox.start(d.editFormSelector),this.sandbox.form.create(d.editFormSelector),this.sandbox.form.setData(d.editFormSelector,this.data),$(d.editFormSelector+" input").first().focus(),this.sandbox.once("husky.overlay.edit-collection.language-changed",function(a){this.languageChanged(a)}.bind(this))}.bind(this))},openOverlay:function(){var a=this.sandbox.dom.createElement('<div class="overlay-element"/>');this.sandbox.dom.append(this.$el,a),this.sandbox.start([{name:"overlay@husky",options:{el:a,title:this.sandbox.translate("sulu.media.edit-collection"),instanceName:"edit-collection",data:this.renderTemplate("/admin/media/template/collection/settings"),okCallback:this.okCallback.bind(this),cancelCallback:function(){this.sandbox.stop()}.bind(this),openOnStart:!0,removeOnClose:!0,closeIcon:"",propagateEvents:!1,languageChanger:{locales:this.sandbox.sulu.locales,preSelected:this.options.locale}}}])},okCallback:function(){return this.sandbox.form.validate(d.editFormSelector)?(this.saveCollection(),void this.sandbox.stop()):!1},saveCollection:function(){var b=$.Deferred();if(this.sandbox.form.validate(d.editFormSelector)){var c=this.sandbox.form.getData(d.editFormSelector),e=this.sandbox.util.extend(!0,{},this.data,c);JSON.stringify(this.data)!==JSON.stringify(e)?(e.locale=this.options.locale,e.parent=this.data._embedded.parent?this.data._embedded.parent.id:null,a.save(e).then(function(a){b.resolve()}.bind(this))):b.resolve()}else b.resolve();return b},languageChanged:function(a){this.saveCollection().then(function(){this.sandbox.stop(this.$find("*")),this.options.locale=a,this.initialize()}.bind(this))},destroy:function(){this.sandbox.emit(e.call(this))}}});