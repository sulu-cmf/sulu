define(["config","services/sulumedia/collection-manager","services/sulumedia/media-manager","services/sulumedia/user-settings-manager","services/sulumedia/overlay-manager","sulusecurity/services/security-checker","services/sulumedia/file-icons"],function(a,b,c,d,e,f,g){"use strict";var h={instanceName:"collection"},i={hideToolbarClass:"toolbar-hidden",dropzoneSelector:".dropzone-container",toolbarSelector:".list-toolbar-container",datagridSelector:".datagrid-container",collectionTitleSelector:".collection-title h2"};return{stickyToolbar:!0,layout:{navigation:{collapsed:!0},content:{width:"max"}},templates:["/admin/media/template/collection/files"],initialize:function(){if(this.options=this.sandbox.util.extend(!0,{},h,this.options),this.bindDatagridEvents(),this.bindDropzoneEvents(),this.bindOverlayEvents(),this.bindManagerEvents(),this.bindListToolbarEvents(),this.sandbox.emit("sulu.medias.collection.get-data",function(a){this.data=a,this.render()}.bind(this)),this.sandbox.sulu.viewStates["media-file-edit-id"]){var a=this.sandbox.sulu.viewStates["media-file-edit-id"];e.startEditMediaOverlay.call(this,a,d.getMediaLocale()),delete this.sandbox.sulu.viewStates["media-file-edit-id"]}},bindDatagridEvents:function(){this.sandbox.on("husky.datagrid.number.selections",function(a){var b=a>0?"enable":"disable";this.sandbox.emit("husky.toolbar."+this.options.instanceName+".item."+b,"media-move",!1),this.sandbox.emit("husky.toolbar."+this.options.instanceName+".item."+b,"editSelected",!1),this.sandbox.emit("husky.toolbar."+this.options.instanceName+".item."+b,"delete",!1)}.bind(this))},bindDropzoneEvents:function(){this.sandbox.on("husky.dropzone."+this.options.instanceName+".success",function(a,b){this.sandbox.emit("sulu.labels.success.show","labels.success.media-upload-desc","labels.success"),this.sandbox.emit("husky.datagrid.records.add",[b])},this)},bindManagerEvents:function(){this.sandbox.on("sulu.medias.media.deleted",function(a){this.sandbox.emit("husky.datagrid.record.remove",a)}.bind(this)),this.sandbox.on("sulu.medias.media.moved",function(a){this.sandbox.emit("husky.datagrid.record.remove",a),this.sandbox.emit("husky.data-navigation.collections.reload")}.bind(this)),this.sandbox.on("sulu.medias.media.saved",function(a,b){b.locale&&b.locale!==d.getMediaLocale()||this.sandbox.emit("husky.datagrid.records.change",this.sandbox.util.extend(!0,{},b,{type:b.type.name?b.type.name:b.type}))}.bind(this))},bindOverlayEvents:function(){this.sandbox.on("sulu.collection-select.move-media.selected",this.moveMedia.bind(this)),this.sandbox.on("sulu.collection-add.initialized",this.disableDropzone.bind(this)),this.sandbox.on("sulu.collection-edit.initialized",this.disableDropzone.bind(this)),this.sandbox.on("sulu.collection-select.move-collection.initialized",this.disableDropzone.bind(this)),this.sandbox.on("sulu.collection-select.move-media.initialized",this.disableDropzone.bind(this)),this.sandbox.on("sulu.media-edit.initialized",this.disableDropzone.bind(this)),this.sandbox.on("sulu.permission-settings.initialized",this.disableDropzone.bind(this)),this.sandbox.on("sulu.collection-add.closed",this.enableDropzone.bind(this)),this.sandbox.on("sulu.collection-edit.closed",this.enableDropzone.bind(this)),this.sandbox.on("sulu.collection-select.move-collection.closed",this.enableDropzone.bind(this)),this.sandbox.on("sulu.collection-select.move-media.closed",this.enableDropzone.bind(this)),this.sandbox.on("sulu.media-edit.closed",this.enableDropzone.bind(this)),this.sandbox.on("sulu.permission-settings.closed",this.enableDropzone.bind(this)),this.sandbox.on("sulu.medias.collection.saved",this.savedHandler.bind(this))},bindListToolbarEvents:function(){this.sandbox.on("sulu.list-toolbar.add",function(){this.sandbox.emit("husky.dropzone."+this.options.instanceName+".show-popup")}.bind(this)),this.sandbox.on("sulu.list-toolbar.delete",this.deleteMedia.bind(this)),this.sandbox.on("sulu.list-toolbar.edit",this.editMedias.bind(this)),this.sandbox.on("sulu.list-toolbar.media-move",function(){e.startMoveMediaOverlay.call(this,this.options.id,d.getMediaLocale())}.bind(this)),this.sandbox.on("sulu.toolbar.change.table",function(){d.setMediaListView("table"),d.setMediaListPagination("dropdown"),this.sandbox.emit("husky.datagrid.change",1,d.getDropdownPageSize(),"table",[],"dropdown"),this.sandbox.stickyToolbar.reset(this.$el)}.bind(this)),this.sandbox.on("sulu.toolbar.change.masonry",function(){d.setMediaListView("datagrid/decorators/masonry-view"),d.setMediaListPagination("infinite-scroll"),this.sandbox.emit("husky.datagrid.change",1,d.getInfinityPageSize(),"datagrid/decorators/masonry-view",null,"infinite-scroll"),this.sandbox.stickyToolbar.reset(this.$el)}.bind(this))},savedHandler:function(a,b){b.locale&&b.locale!==d.getMediaLocale()||$(i.collectionTitleSelector).text(b.title)},render:function(){this.sandbox.dom.html(this.$el,this.renderTemplate("/admin/media/template/collection/files")),f.hasPermission(this.data,"add")&&this.startDropzone(),this.startDatagrid()},startDatagrid:function(){var a=d.getMediaListView(),b=[],c={};f.hasPermission(this.data,"add")&&(c.add={options:{callback:function(){this.sandbox.emit("sulu.list-toolbar.add")}.bind(this)}}),f.hasPermission(this.data,"edit")&&(c.editSelected={options:{callback:function(){this.sandbox.emit("sulu.list-toolbar.edit")}.bind(this)}}),f.hasPermission(this.data,"delete")&&(c.deleteSelected={options:{callback:function(){this.sandbox.emit("sulu.list-toolbar.delete")}.bind(this)}}),f.hasPermission(this.data,"edit")&&b.push({id:"media-move",title:this.sandbox.translate("sulu.media.move"),callback:function(){this.sandbox.emit("sulu.list-toolbar.media-move")}.bind(this)}),b.push({type:"columnOptions"}),c.settings={options:{dropdownItems:b}},c.mediaDecoratorDropdown={},this.sandbox.sulu.initListToolbarAndList.call(this,"media","/admin/api/media/fields",{el:this.$find(i.toolbarSelector),instanceName:this.options.instanceName,template:this.sandbox.sulu.buttons.get(c)},{el:this.$find(i.datagridSelector),url:"/admin/api/media?locale="+d.getMediaLocale()+"&collection="+this.options.id,searchFields:["name","title","description"],view:a,pagination:d.getMediaListPagination(),resultKey:"media",actionCallback:function(a){this.editMedia(a)}.bind(this),viewOptions:{table:{actionIconColumn:"name",noImgIcon:function(a){return g.getByMimeType(a.mimeType)},badges:[{column:"title",callback:function(a,b){return a.locale!==d.getMediaLocale()?(b.title=a.locale,b):void 0}.bind(this)}],emptyIcon:"fa-file-o"},"datagrid/decorators/masonry-view":{noImgIcon:function(a){return g.getByMimeType(a.mimeType)},emptyIcon:"fa-file-o",locale:d.getMediaLocale()}},paginationOptions:{"infinite-scroll":{reachedBottomMessage:"public.reached-list-end",scrollOffset:500}}})},startDropzone:function(){this.sandbox.start([{name:"dropzone@husky",options:{el:this.$find(i.dropzoneSelector),maxFilesize:a.get("sulu-media").maxFilesize,url:"/admin/api/media?collection="+this.options.id+"&locale="+d.getMediaLocale(),method:"POST",paramName:"fileVersion",instanceName:this.options.instanceName}}])},moveMedia:function(a){this.sandbox.emit("husky.datagrid.items.get-selected",function(b){c.move(b,a.id)}.bind(this))},editMedias:function(){this.sandbox.emit("husky.datagrid.items.get-selected",function(a){e.startEditMediaOverlay.call(this,a,d.getMediaLocale())}.bind(this))},editMedia:function(a){e.startEditMediaOverlay.call(this,[a],d.getMediaLocale())},deleteMedia:function(){this.sandbox.emit("husky.datagrid.items.get-selected",function(a){this.sandbox.sulu.showDeleteDialog(function(b){b&&c["delete"](a)}.bind(this))}.bind(this))},disableDropzone:function(){this.sandbox.emit("husky.dropzone."+this.options.instanceName+".disable")},enableDropzone:function(){this.sandbox.emit("husky.dropzone."+this.options.instanceName+".enable")}}});