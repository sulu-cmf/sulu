define(["services/husky/util","services/husky/mediator","sulumedia/models/media"],function(a,b,c){"use strict";function d(){}var e=null,f=function(a){var d=$.Deferred(),e=c.findOrCreate({id:a});return e.destroy({success:function(){b.emit("sulu.medias.media.deleted",a),b.emit("sulu.labels.success.show","labels.success.media-deleted-desc"),d.resolve()}.bind(this),error:function(){d.reject()}.bind(this)}),d},g=function(c,d,e){var f=$.Deferred();return a.save("/admin/api/media/"+c+"?action=move&destination="+d+"&locale="+e,"POST").done(function(){b.emit("sulu.medias.media.moved",c,d),b.emit("sulu.labels.success.show","labels.success.media-move-desc"),f.resolve()}.bind(this)).fail(function(){f.reject()}.bind(this)),f},h=function(a){var b=$.Deferred(),d=c.findOrCreate({id:a.id});return d.set(a),d.save(null,{success:function(a){b.resolve(a.toJSON())}.bind(this),error:function(a,c){b.reject(c)}.bind(this)}),b};return d.prototype={loadOrNew:function(a,d){var e,f=$.Deferred();return a?(e=c.findOrCreate({id:a}),e.clear(),e.set({id:a}),e.fetch({data:{locale:d},success:function(c){b.emit("sulu.medias.media.loaded",a),f.resolve(c.toJSON())}.bind(this),error:function(){f.reject()}.bind(this)})):(e=new c,b.emit("sulu.medias.media.created"),f.resolve(e.toJSON())),f},"delete":function(b){$.isArray(b)||(b=[b]);var c=[],d=$.Deferred();return a.each(b,function(a,b){c.push(f(b))}.bind(this)),$.when.apply(null,c).done(function(){d.resolve()}.bind(this)).fail(function(){d.reject()}.bind(this)),d},save:function(a){var c=$.Deferred();return h(a).done(function(a){b.emit("sulu.medias.media.saved",a.id,a),b.emit("sulu.labels.success.show","labels.success.media-save-desc"),c.resolve(a)}.bind(this)).fail(function(a){a.status&&403===a.status||b.emit("sulu.labels.error.show"),c.reject()}.bind(this)),c},move:function(b,c,d){$.isArray(b)||(b=[b]);var e=[],f=$.Deferred();return a.each(b,function(a,b){e.push(g(b,c,d))}.bind(this)),$.when.apply(null,e).done(function(){f.resolve()}.bind(this)).fail(function(){f.reject()}.bind(this)),f}},d.getInstance=function(){return null===e&&(e=new d),e},d.getInstance()});