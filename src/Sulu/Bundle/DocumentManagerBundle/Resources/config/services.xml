<?xml version="1.0" ?>

<container xmlns="http://symfony.com/schema/dic/services"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd">

    <services>
        <!-- Core -->
        <service id="sulu_document_manager" class="Sulu\Component\DocumentManager\DocumentManager">
            <argument type="service" id="event_dispatcher" />
            <argument type="service" id="sulu_document_manager.node_manager" />
        </service>

        <service id="sulu_document_manager.document_registry" class="Sulu\Component\DocumentManager\DocumentRegistry" />

        <service id="sulu_document_manager.node_manager" class="Sulu\Component\DocumentManager\NodeManager">
            <argument type="service" id="doctrine_phpcr.default_session" />
        </service>

        <service id="sulu_document_manager.metadata_factory" class="Sulu\Component\DocumentManager\MetadataFactory">
            <argument>%sulu_document_manager.mapping%</argument>
        </service>

        <service id="sulu_document_manager.slugifier" class="Symfony\Cmf\Bundle\CoreBundle\Slugifier\CallbackSlugifier">
            <argument>Ferrandini\Urlizer::urlize</argument>
        </service>

        <service id="sulu_document_manager.namespace_registry" class="Sulu\Component\DocumentManager\NamespaceRegistry">
            <argument>%sulu_document_manager.namespace_mapping%</argument>
        </service>

        <service id="sulu_document_manager.property_encoder" class="Sulu\Bundle\DocumentManagerBundle\Bridge\PropertyEncoder">
            <argument type="service" id="sulu_document_manager.namespace_registry" />
        </service>

        <!-- Utilities -->
        <service id="sulu_document_manager.path_segment_registry" class="Sulu\Component\DocumentManager\PathSegmentRegistry">
            <argument type="collection">
                <argument key="base">%sulu.content.node_names.base%</argument>
                <argument key="content">%sulu.content.node_names.content%</argument>
                <argument key="route">%sulu.content.node_names.route%</argument>
                <argument key="snippet">%sulu.content.node_names.snippet%</argument>
            </argument>
        </service>

        <service id="sulu_document_manager.document_inspector" class="Sulu\Bundle\DocumentManagerBundle\Bridge\DocumentInspector">
            <argument type="service" id="sulu_document_manager.document_registry" />
            <argument type="service" id="sulu_document_manager.path_segment_registry" />
            <argument type="service" id="sulu_document_manager.namespace_registry" />
            <argument type="service" id="sulu_document_manager.proxy_factory" />
            <argument type="service" id="sulu_document_manager.metadata_factory" />
            <argument type="service" id="sulu_content.structure.factory" />
        </service>

        <!-- Proxy manager -->
        <service id="sulu_document_manager.proxy_factory" class="Sulu\Component\DocumentManager\ProxyFactory">
            <argument type="service" id="sulu_document_manager.proxy_manager.factory.ghost" />
            <argument type="service" id="event_dispatcher" />
            <argument type="service" id="sulu_document_manager.document_registry" />
            <argument type="service" id="sulu_document_manager.metadata_factory" />
        </service>

        <service id="sulu_document_manager.proxy_manager.factory.ghost" class="ProxyManager\Factory\LazyLoadingGhostFactory" />

        <!-- Behavior Subscribers !-->
        <service id="sulu_document_manager.subscriber.behavior.auto_name" class="Sulu\Component\DocumentManager\Subscriber\Behavior\AutoNameSubscriber">
            <argument type="service" id="sulu_document_manager.document_registry" />
            <argument type="service" id="sulu_document_manager.slugifier" />
            <argument type="service" id="sulu_document_manager.metadata_factory" />
            <tag name="kernel.event_subscriber" />
        </service>

        <service id="sulu_document_manager.suscriber.behavior.blame" class="Sulu\Component\DocumentManager\Subscriber\Behavior\BlameSubscriber">
            <argument type="service" id="sulu_document_manager.property_encoder" />
            <argument type="service" id="security.token_storage" />
            <tag name="kernel.event_subscriber" />
        </service>

        <service id="sulu_document_manager.suscriber.behavior.timestamp" class="Sulu\Component\DocumentManager\Subscriber\Behavior\TimestampSubscriber">
            <argument type="service" id="sulu_document_manager.property_encoder" />
            <tag name="kernel.event_subscriber" />
        </service>

        <service id="sulu_document_manager.suscriber.behavior.node_name" class="Sulu\Component\DocumentManager\Subscriber\Behavior\NodeNameSubscriber">
            <tag name="kernel.event_subscriber" />
        </service>

        <service id="sulu_document_manager.suscriber.behavior.uuid" class="Sulu\Component\DocumentManager\Subscriber\Behavior\UuidSubscriber">
            <tag name="kernel.event_subscriber" />
        </service>

        <service id="sulu_document_manager.suscriber.behavior.locale" class="Sulu\Component\DocumentManager\Subscriber\Behavior\LocaleSubscriber">
            <tag name="kernel.event_subscriber" />
            <argument type="service" id="sulu_document_manager.document_registry" />
        </service>

        <service id="sulu_document_manager.suscriber.behavior.parent" class="Sulu\Component\DocumentManager\Subscriber\Behavior\ParentSubscriber">
            <argument type="service" id="sulu_document_manager.proxy_factory" />
            <tag name="kernel.event_subscriber" />
        </service>

        <service id="sulu_document_manager.suscriber.behavior.children" class="Sulu\Component\DocumentManager\Subscriber\Behavior\ChildrenSubscriber">
            <argument type="service" id="sulu_document_manager.proxy_factory" />
            <tag name="kernel.event_subscriber" />
        </service>

        <service id="sulu_document_manager.subscriber.behavior.path" class="Sulu\Component\DocumentManager\Subscriber\Behavior\PathSubscriber">
            <argument type="service" id="sulu_document_manager.document_inspector" />
            <tag name="kernel.event_subscriber" />
        </service>

        <!-- Core Subscribers -->
        <service id="sulu_document_manager.subscriber.core.instantiator" class="Sulu\Component\DocumentManager\Subscriber\Core\InstantiatorSubscriber">
            <argument type="service" id="sulu_document_manager.metadata_factory" />
            <tag name="kernel.event_subscriber" />
        </service>

        <service id="sulu_document_manager.subscriber.core.registrator" class="Sulu\Component\DocumentManager\Subscriber\Core\RegistratorSubscriber">
            <argument type="service" id="sulu_document_manager.document_registry" />
            <tag name="kernel.event_subscriber" />
        </service>

        <service id="sulu_document_manager.subscriber.phpcr.find" class="Sulu\Component\DocumentManager\Subscriber\Phpcr\FindSubscriber">
            <argument type="service" id="sulu_document_manager.metadata_factory" />
            <argument type="service" id="sulu_document_manager.node_manager" />
            <argument type="service" id="event_dispatcher" />
            <tag name="kernel.event_subscriber" />
        </service>

        <service id="sulu_document_manager.subscriber.query" class="Sulu\Component\DocumentManager\Subscriber\Phpcr\QuerySubscriber">
            <argument type="service" id="doctrine_phpcr.default_session" />
            <argument type="service" id="event_dispatcher" />
            <tag name="kernel.event_subscriber" />
        </service>

        <service id="sulu_document_manager.subscriber.general" class="Sulu\Component\DocumentManager\Subscriber\Phpcr\GeneralSubscriber">
            <argument type="service" id="sulu_document_manager.document_registry" />
            <argument type="service" id="sulu_document_manager.node_manager" />
            <tag name="kernel.event_subscriber" />
        </service>

    </services>

</container>
