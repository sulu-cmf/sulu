define(["sulusnippet/model/snippet","app-config"],function(a,b){"use strict";var c="contentLanguage",d=function(){},e={deleteReferencedByFollowing:"snippet.delete-referenced-by-following",deleteConfirmText:"snippet.delete-confirm-text",deleteConfirmDefaultText:"snippet.delete-confirm-default-text",deleteConfirmTitle:"snippet.delete-confirm-title",deleteDoIt:"snippet.delete-do-it",deleteNoSnippetsSelected:"snippet.delete-no-snippets-selected"},f={referentialIntegrityMessage:function(a,b){var c=[];return a.length>0&&(c.push("<p>",this.sandbox.translate(e.deleteReferencedByFollowing),"</p>"),c.push("<ul>"),this.sandbox.util.foreach(a,function(a){c.push("<li>",a,"</li>")}),c.push("</ul>")),b&&c.push("<p>",this.sandbox.translate(e.deleteConfirmDefaultText),"</p>"),c.push("<p>",this.sandbox.translate(e.deleteConfirmText),"</p>"),c.join("")}};return d.prototype={bindModelEvents:function(){this.sandbox.on("sulu.snippets.snippet.delete",this.del,this),this.sandbox.on("sulu.snippets.snippet.save",this.save,this),this.sandbox.on("sulu.snippets.snippet.load",this.load,this),this.sandbox.on("sulu.snippets.snippet.new",this.add,this),this.sandbox.on("sulu.snippets.snippets.delete",this.delSnippets,this),this.sandbox.on("sulu.snippets.snippet.list",function(a){var b="snippet/snippets";a&&(b+="/"+a),this.sandbox.emit("sulu.router.navigate",b)},this),this.sandbox.on("sulu.header.language-changed",function(a){if(this.sandbox.sulu.saveUserSetting(c,a.id),"edit"===this.type){var b=this.model.toJSON();this.sandbox.emit("sulu.snippets.snippet.load",b.id,a.id)}else"add"===this.type?this.sandbox.emit("sulu.snippets.snippet.new",a.id):this.sandbox.emit("sulu.snippets.snippet.list",a.id)},this)},del:function(){this.sandbox.sulu.showDeleteDialog(function(a){a&&(this.destroySnippet(this.model,function(){this.sandbox.emit("sulu.router.navigate","snippet/snippets")}.bind(this)),this.sandbox.emit("sulu.header.toolbar.item.loading","settings"))}.bind(this))},destroySnippet:function(a,b){a.destroy({success:function(){b()}.bind(this),error:function(c,d){409==d.status&&this.referentialIntegrityDialog(a,d.responseJSON,b)}.bind(this)})},referentialIntegrityDialog:function(a,b,c){var d=[];this.sandbox.util.foreach(b.structures,function(a){d.push(a.title)});var g=$("<div/>");$("body").append(g),this.sandbox.start([{name:"overlay@husky",options:{el:g,openOnStart:!0,title:this.sandbox.translate(e.deleteConfirmTitle),message:f.referentialIntegrityMessage.call(this,d,b.isDefault),okDefaultText:this.sandbox.translate(e.deleteDoIt),type:"alert",closeCallback:function(){},okCallback:function(){a.destroy({headers:{SuluForceRemove:!0},success:function(){c()}.bind(this)})}.bind(this)}}])},save:function(a,c){if(this.sandbox.emit("sulu.header.toolbar.item.loading","save"),this.template)a.template=this.template;else{var d=b.getSection("sulu-snippet");a.template=d.defaultType}this.model.set(a),this.model.fullSave(this.template,this.options.language,null,{},{success:function(a){var b=a.toJSON();this.data.id&&this.sandbox.emit("sulu.snippets.snippet.saved",b),"back"===c?this.sandbox.emit("sulu.snippets.snippet.list"):"new"===c?this.sandbox.emit("sulu.router.navigate","snippet/snippets/"+this.options.language+"/add",!0,!0):this.data.id||this.sandbox.emit("sulu.router.navigate","snippet/snippets/"+this.options.language+"/edit:"+b.id)}.bind(this),error:function(){this.sandbox.emit("sulu.snippets.snippet.save-error"),this.sandbox.logger.log("error while saving profile")}.bind(this)})},load:function(a,b,c){b||(b=this.options.language),this.sandbox.emit("sulu.router.navigate","snippet/snippets/"+b+"/edit:"+a,void 0,void 0,c)},add:function(a){a||(a=this.options.language),this.sandbox.emit("sulu.router.navigate","snippet/snippets/"+a+"/add")},delSnippets:function(b){if(b.length<1)return void this.sandbox.emit("sulu.dialog.error.show",this.sandbox.translate(e.deleteNoSnippetsSelected));var c=function(){var d=b.shift();if(void 0!==d){var e=new a({id:d});this.destroySnippet(e,function(){this.sandbox.emit("husky.datagrid.record.remove",d),c()}.bind(this))}}.bind(this);this.sandbox.sulu.showDeleteDialog(function(a){a&&c()}.bind(this))},getCopyLocaleUrl:function(a,b,c){return["/admin/api/snippets/",a,"?language=",b,"&dest=",c,"&action=copy-locale"].join("")}},d});