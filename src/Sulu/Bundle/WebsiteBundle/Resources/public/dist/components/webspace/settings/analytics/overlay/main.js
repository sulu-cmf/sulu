define(["jquery","underscore","text!./form.html","text!./input.html","text!./textarea.html","text!./piwik.html"],function(a,b,c,d,e,f){"use strict";const g="#analytics-form",h=".analytics-content-wrapper";var i={options:{saveCallback:function(){},types:[{id:"google",title:"website.webspace.settings.type.google",input:"input",labels:["website.webspace.settings.key"],inputTemplate:d},{id:"piwik",title:"website.webspace.settings.type.piwik",input:"input",labels:["public.url","website.webspace.settings.site-id"],inputTemplate:f},{id:"custom",title:"website.webspace.settings.type.custom",input:"textarea",labels:["website.webspace.settings.script"],inputTemplate:e}]},templates:{form:c,skeleton:'<div id="webspace-analytics-overlay"/>',url:"/admin/api/webspaces/<%= webspaceKey %>/analytics<% if (!!id) { %>/<%= id %><% } %>"},translations:{overlayTitle:"website.webspace.settings.edit.title",script:"website.webspace.settings.script",domain:"website.webspace.settings.edit.domain",environment:"website.webspace.settings.edit.environment"}};return{defaults:i,initialize:function(){this.$el.html(this.templates.skeleton),this.startOverlay()},startOverlay:function(){this.sandbox.start([{name:"overlay@husky",options:{el:"#webspace-analytics-overlay",openOnStart:!0,removeOnClose:!0,slides:[{title:this.translations.overlayTitle,data:this.templates.form({translations:this.translations}),okCallback:function(){return this.sandbox.form.validate(g)?void this.options.saveCallback(this.options.id,this.getData()):!1}.bind(this)}]}}]).then(function(){this.sandbox.form.create(g).initialized.then(function(){this.sandbox.form.setData(g,this.data).then(this.initializeFormComponents.bind(this))}.bind(this))}.bind(this))},getData:function(){var c=this.sandbox.form.getData(g),d=a("#analytics-domains").data("selected");return c.domains=b.map(d,this.findDomainByUrl.bind(this)),c},findDomainByUrl:function(a){return b.find(this.options.urls,function(b){return b.url===a})},initializeFormComponents:function(){var a=[];this.data.domains&&(a=b.map(this.data.domains,function(a){return a.url})),this.sandbox.start([{name:"select@husky",options:{el:"#analytics-type",multipleSelect:!1,valueName:"title",instanceName:"analytics-overlay",data:this.options.types,selectCallback:this.changeType.bind(this)}},{name:"datagrid@husky",options:{el:"#analytics-domains",instanceName:"analytics-overlay",data:this.options.urls,idKey:"url",preselected:a,matchings:[{attribute:"url",content:this.translations.domain}]}}]),this.changeType(this.data.type,this.data)},changeType:function(c,d){var e=b.find(this.options.types,function(a){return a.id===c});if(e){d||(d=this.getData()),this.sandbox.form.removeField(g,h),a(h).children().remove(),a(h).html(b.template(e.inputTemplate,{labels:b.map(e.labels,function(a){return this.sandbox.translate(a)}.bind(this))}));var f=[];a(h).find("*[data-mapper-property]").each(function(b,c){f.push(this.sandbox.form.addField(g,a(c)).initialized)}.bind(this)),a.when(f).then(function(){this.sandbox.form.setData(g,d)}.bind(this))}},loadComponentData:function(){var a=this.sandbox.data.deferred();return this.options.id?(this.sandbox.util.load(this.templates.url(this.options)).then(function(b){a.resolve(b)}),a.promise()):(a.resolve({}),a.promise())}}});