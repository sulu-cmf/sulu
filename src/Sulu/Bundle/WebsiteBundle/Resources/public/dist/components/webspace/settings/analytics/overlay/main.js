define(["jquery","underscore","config","text!./form.html","text!./input.html","text!./textarea.html","text!./piwik.html"],function(a,b,c,d,e,f,g){"use strict";var h="#analytics-form",i=".analytics-content-wrapper",j={options:{saveCallback:function(){},types:[{id:"google",title:"website.webspace.settings.type.google",input:"input",labels:["website.webspace.settings.key"],inputTemplate:e},{id:"google_tag_manager",title:"website.webspace.settings.type.google_tag_manager",input:"input",labels:["website.webspace.settings.key"],inputTemplate:e},{id:"piwik",title:"website.webspace.settings.type.piwik",input:"input",labels:["website.webspace.settings.url","website.webspace.settings.site-id"],inputTemplate:g},{id:"custom",title:"website.webspace.settings.type.custom",input:"textarea",labels:["website.webspace.settings.script"],inputTemplate:f}]},templates:{form:d,skeleton:'<div id="webspace-analytics-overlay"/>',url:"/admin/api/webspaces/<%= webspaceKey %>/analytics<% if (!!id) { %>/<%= id %><% } %>"},translations:{overlayTitle:"website.webspace.settings.edit.title",script:"website.webspace.settings.script",domain:"website.webspace.settings.edit.domain",environment:"website.webspace.settings.edit.environment",pleaseChoose:"dropdown.please-choose"}};return{defaults:j,initialize:function(){this.$el.html(this.templates.skeleton),this.startOverlay()},bindDomEvents:function(){this.sandbox.dom.on("#analytics-all-domains","change",function(){a("#analytics-domains-container").toggle()})},startOverlay:function(){var a=c.get("sulu_security.contexts")["sulu.webspace_settings."+this.options.webspaceKey+".analytics"],b=[{type:"cancel",inactive:!1,align:"center"}];(this.options.id&&a.edit||!this.options.id&&a.add)&&(b=[{type:"ok",inactive:!1,align:"right"},{type:"cancel",inactive:!1,align:"left"}]),this.sandbox.start([{name:"overlay@husky",options:{el:"#webspace-analytics-overlay",openOnStart:!0,removeOnClose:!0,skin:"medium",slides:[{title:this.translations.overlayTitle,data:this.templates.form({translations:this.translations}),okCallback:function(){return this.sandbox.form.validate(h)?void this.options.saveCallback(this.options.id,this.getData()):!1}.bind(this),buttons:b}]}}]).then(function(){this.sandbox.form.create(h).initialized.then(function(){this.sandbox.form.setData(h,this.data).then(this.initializeFormComponents.bind(this)),this.bindDomEvents()}.bind(this))}.bind(this))},getData:function(){var c=this.sandbox.form.getData(h),d=a("#analytics-domains").data("selected");return c.domains=b.map(d,this.findDomainByUrl.bind(this)),c},findDomainByUrl:function(a){return b.find(this.options.urls,function(b){return b.url===a})},initializeFormComponents:function(){var c=[];this.data.domains&&(c=b.map(this.data.domains,function(a){return a.url})),this.sandbox.start([{name:"select@husky",options:{el:"#analytics-type",isNative:!0,multipleSelect:!1,valueName:"title",instanceName:"analytics-overlay",defaultLabel:this.translations.pleaseChoose,data:this.options.types,selectCallback:function(a){this.changeType(a)}.bind(this),preselectCallback:function(){}}},{name:"datagrid@husky",options:{el:"#analytics-domains",instanceName:"analytics-overlay",data:this.options.urls,idKey:"url",preselected:c,matchings:[{attribute:"url",content:this.translations.domain}]}}]),this.changeType(this.data.type,this.data),this.data.allDomains&&a("#analytics-domains-container").hide()},changeType:function(c,d){var e=b.find(this.options.types,function(a){return a.id===c});if(e){d||(d=this.getData()),d.content!==this.data.content&&(d.content=null),this.sandbox.form.removeField(h,i),a(i).children().remove(),a(i).html(b.template(e.inputTemplate,{labels:b.map(e.labels,function(a){return this.sandbox.translate(a)}.bind(this))}));var f=[];a(i).find("*[data-mapper-property]").each(function(b,c){f.push(this.sandbox.form.addField(h,a(c)).initialized)}.bind(this)),a.when(f).then(function(){this.sandbox.form.setData(h,d)}.bind(this))}},loadComponentData:function(){var a=this.sandbox.data.deferred();return this.options.id?(this.sandbox.util.load(this.templates.url(this.options)).then(function(b){a.resolve(b)}),a.promise()):(a.resolve({}),a.promise())}}});