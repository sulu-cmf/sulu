define(["jquery","underscore","text!./form.html"],function(a,b,c){"use strict";const d="#analytics-form",e="#analytics-content";var f={options:{saveCallback:function(){},types:[{id:"google",title:"website.webspace.settings.type.google",input:"input",label:"website.webspace.settings.key"},{id:"piwik",title:"website.webspace.settings.type.piwik",input:"input",label:"website.webspace.settings.key"},{id:"custom",title:"website.webspace.settings.type.custom",input:"textarea",label:"website.webspace.settings.script"}]},templates:{form:c,skeleton:'<div id="webspace-analytics-overlay"/>',url:"/admin/api/webspaces/<%= webspaceKey %>/analytics<% if (!!id) { %>/<%= id %><% } %>",input:['<input id="analytics-content" type="text" name="content" class="form-element"','data-mapper-property="content" data-validation-required="true" data-validation-min-length="3"/>'].join(""),textarea:['<textarea id="analytics-content" name="content" class="form-element" data-mapper-property="content"','data-validation-required="true" data-validation-min-length="3"></textarea>'].join("")},translations:{overlayTitle:"website.webspace.settings.edit.title",script:"website.webspace.settings.script",domain:"website.webspace.settings.edit.domain",environment:"website.webspace.settings.edit.environment"}};return{defaults:f,initialize:function(){this.$el.html(this.templates.skeleton),this.startOverlay()},startOverlay:function(){this.sandbox.start([{name:"overlay@husky",options:{el:"#webspace-analytics-overlay",openOnStart:!0,removeOnClose:!0,slides:[{title:this.translations.overlayTitle,data:this.templates.form({translations:this.translations}),okCallback:function(){return this.sandbox.form.validate(d)?void this.options.saveCallback(this.options.id,this.getData()):!1}.bind(this)}]}}]).then(function(){this.sandbox.form.create(d).initialized.then(function(){this.sandbox.form.setData(d,this.data).then(this.initializeFormComponents.bind(this))}.bind(this))}.bind(this))},getData:function(){var c=this.sandbox.form.getData(d),e=a("#analytics-domains").data("selected");return c.domains=b.map(e,this.findDomainByUrl.bind(this)),c},findDomainByUrl:function(a){return b.find(this.options.urls,function(b){return b.url===a})},initializeFormComponents:function(){var a=[];this.data.domains&&(a=b.map(this.data.domains,function(a){return a.url})),this.sandbox.start([{name:"select@husky",options:{el:"#analytics-type",multipleSelect:!1,valueName:"title",instanceName:"analytics-overlay",data:this.options.types,selectCallback:this.changeType.bind(this)}},{name:"datagrid@husky",options:{el:"#analytics-domains",instanceName:"analytics-overlay",data:this.options.urls,idKey:"url",preselected:a,matchings:[{attribute:"url",content:this.translations.domain}]}}]),this.changeType(this.data.type,this.data)},changeType:function(c,f){var g=b.find(this.options.types,function(a){return a.id===c});g&&(f||(f=this.getData()),this.sandbox.form.removeField(d,e),a(e).remove(),a(".analytics-content-wrapper").append(a(this.templates[g.input]())),a("#analytics-content-label").text(this.sandbox.translate(g.label)),this.sandbox.form.addField(d,e).initialized.then(function(){this.sandbox.form.setData(d,f)}.bind(this)))},loadComponentData:function(){var a=this.sandbox.data.deferred();return this.options.id?(this.sandbox.util.load(this.templates.url(this.options)).then(function(b){a.resolve(b)}),a.promise()):(a.resolve({}),a.promise())}}});