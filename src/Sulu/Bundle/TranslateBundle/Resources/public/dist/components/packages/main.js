define(["sulutranslate/models/package","sulutranslate/models/code","sulutranslate/collections/catalogues","sulutranslate/collections/translations"],function(a,b,c,d){"use strict";return{initialize:function(){if(this.bindCustomEvents(),"list"===this.options.display)this.renderList();else if("details"===this.options.display)this.renderDetails();else{if("settings"!==this.options.display)throw"display type wrong";this.renderSettings()}},bindCustomEvents:function(){this.sandbox.on("sulu.translate.package.delete",function(a){this.del(a)},this),this.sandbox.on("sulu.translate.package.save",function(a){this.save(a)},this),this.sandbox.on("sulu.translate.package.load",function(a){this.load(a)},this),this.sandbox.on("sulu.translate.package.list",function(){this.sandbox.emit("sulu.router.navigate","settings/translate")},this),this.sandbox.on("sulu.translate.package.new",function(){this.add()},this),this.sandbox.on("sulu.translate.translations.save",function(a,b){this.saveTranslations(a,b)},this),this.sandbox.on("sulu.translate.packages.delete",function(a){this.delPackages(a)},this),this.sandbox.on("sulu.translate.catalogue.changed",function(a,b){this.sandbox.emit("sulu.router.navigate","settings/translate/edit:"+a+"/details:"+b)},this)},getModel:function(b){var c=a.findOrCreate(b);return c||(c=new a({id:b})),c},renderList:function(){var a=this.sandbox.dom.createElement('<div id="roles-list-container"/>');this.html(a),this.sandbox.start([{name:"packages/components/list@sulutranslate",options:{el:a}}])},renderSettings:function(){var b=this.sandbox.dom.createElement('<div id="roles-settings-container"/>');this.html(b);var c;this.options.id?(c=this.getModel(this.options.id),c.fetch({success:function(a){this.sandbox.start([{name:"packages/components/settings@sulutranslate",options:{el:b,data:a.toJSON()}}])}.bind(this),error:function(){this.sandbox.logger.log("error while fetching contact")}.bind(this)})):(c=new a,this.sandbox.start([{name:"packages/components/settings@sulutranslate",options:{el:b,data:c.toJSON()}}]))},renderDetails:function(){if(this.options.id){var a=this.getModel(this.options.id);a.fetch({success:function(a){this.loadCatalogues(a)}.bind(this),error:function(){this.sandbox.logger.log("error while fetching contact")}.bind(this)})}},add:function(){this.sandbox.emit("sulu.router.navigate","settings/translate/add")},load:function(a){this.sandbox.emit("sulu.router.navigate","settings/translate/edit:"+a+"/details")},save:function(b){var c=new a;b.id&&(c=this.getModel(b.id)),this.sandbox.emit("sulu.header.toolbar.item.loading","save"),c.set(b),c.save(null,{success:function(a){var c=a.toJSON();b.id?this.sandbox.emit("sulu.translate.package.saved",c.id,c):this.sandbox.emit("sulu.router.navigate","settings/translate/edit:"+c.id+"/settings")}.bind(this),error:function(){this.sandbox.logger.log("error while saving profile")}.bind(this)})},del:function(a){this.confirmDeleteDialog(function(b){if(b){var c=this.getModel(a);c.destroy({success:function(){this.sandbox.emit("sulu.router.navigate","settings/translate")}.bind(this)})}}.bind(this))},loadCatalogues:function(a){var b,c=a.get("catalogues");if(!c.at(0))throw"error: no catalogue exists";this.options.catalogue?b=c.get(this.options.catalogue):(b=c.findWhere({isDefault:!0}),b||(b=c.at(0))),this.loadTranslations(a,b)},loadTranslations:function(a,b){var c=this.sandbox.dom.createElement('<div id="roles-details-container"/>');this.html(c),this.translations=new d({translateCatalogueId:b.get("id")}),this.translations.fetch({success:function(){this.sandbox.start([{name:"packages/components/details@sulutranslate",options:{el:c,data:a.toJSON(),selectedCatalogue:b.toJSON(),translations:this.translations.toJSON()}}])}.bind(this),error:function(){}.bind(this)})},saveTranslations:function(a,c){var d=new $.Deferred,e=0,f=function(){e--,0===e&&d.resolve()};this.sandbox.emit("sulu.header.toolbar.item.loading","save"),this.sandbox.util.each(c,function(a){e++;var d=new b({id:c[a]});d.destroy({success:function(){this.sandbox.logger.log("Code deleted"),f()}.bind(this),error:function(){}})}.bind(this)),a.length>0&&(e++,this.translations.save(this.sandbox,a,{success:function(){f()}.bind(this)})),d.then(function(){this.sandbox.mvc.history.loadUrl(this.sandbox.mvc.history.fragment)}.bind(this))},delPackages:function(a){this.confirmDeleteDialog(function(b){b&&a.forEach(function(a){var b=this.getModel(a);b.destroy({success:function(){this.sandbox.emit("husky.datagrid.record.remove",a)}.bind(this)})}.bind(this))})},confirmDeleteDialog:function(a){if(a&&"function"!=typeof a)throw"callback is not a function";this.sandbox.emit("sulu.overlay.show-warning","sulu.overlay.be-careful","sulu.overlay.delete-desc",function(){a.call(this,!1)}.bind(this),function(){a.call(this,!0)}.bind(this))}}});