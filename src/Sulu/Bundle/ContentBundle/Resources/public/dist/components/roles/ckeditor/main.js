define(["underscore","jquery","config","services/sulusecurity/role-router","text!./skeleton.html"],function(a,b,c,d,e){"use strict";return{defaults:{options:{},translations:{all:"security.roles.all",none:"security.roles.none",general:"security.roles.ckeditor.general",type:"security.roles.ckeditor.type",horizontal:"security.roles.ckeditor.horizontal",vertical:"security.roles.ckeditor.vertical"},templates:{skeleton:e}},initialize:function(){this.toolbar=this.sandbox.ckeditor.getAvailableToolbar(),this.render(),this.bindDOMEvents(),this.bindCustomEvents()},bindDOMEvents:function(){this.sandbox.dom.on("#select-all","click",function(){this.sandbox.emit("husky.matrix.set-all")}.bind(this))},bindCustomEvents:function(){this.sandbox.on("sulu.header.back",d.toList),this.sandbox.on("husky.matrix.changed",this.changeData.bind(this)),this.sandbox.on("husky.matrix.changed",function(){this.sandbox.emit("sulu.header.toolbar.item.enable","save",!0)}.bind(this)),this.sandbox.on("sulu.toolbar.save",this.save.bind(this)),this.sandbox.on("sulu.toolbar.delete",function(){this.sandbox.sulu.showDeleteDialog(function(a){a&&this.data.destroy()}.bind(this))}.bind(this))},render:function(){var a=this.prepareMatrixValues(),b=this.prepareMatrixData();this.$el.html(this.templates.skeleton({translations:this.translations,content:this.data.toJSON()})),this.sandbox.start([{name:"matrix@husky",options:{el:"#matrix-container",captions:{all:this.translations.all,none:this.translations.none,type:this.translations.type,horizontal:this.translations.horizontal,vertical:a.vertical},values:a,data:b}}])},prepareMatrixValues:function(){var b=[],c=[];for(var d in this.toolbar)this.toolbar.hasOwnProperty(d)&&(b.push(d),c.push(a.map(this.toolbar[d],function(a){return{value:a,icon:this.sandbox.ckeditor.getIcon(a),title:a}}.bind(this))));return{vertical:b,horizontal:c}},prepareMatrixData:function(){var b=[];for(var c in this.toolbar)b.push(a.map(this.toolbar[c],function(b){return a.contains(this.data.toolbar[c],b)}.bind(this)));return b},changeData:function(b){if("string"!=typeof b.value)return void this.sandbox.dom.each(b.value,function(a,c){this.changeData({section:b.section,value:c.value,activated:b.activated})}.bind(this));if(b.activated){if(a.contains(this.data.toolbar[b.section],b.value))return;return this.data.toolbar[b.section]||(this.data.toolbar[b.section]=[]),void this.data.toolbar[b.section].push(b.value)}var c=this.data.toolbar[b.section].indexOf(b.value);c>-1&&this.data.toolbar[b.section].splice(c,1)},save:function(a){this.sandbox.emit("sulu.header.toolbar.item.loading","save"),b.ajax("/admin/api/roles/"+this.data.id+"/settings/ckeditor-toolbar",{method:"PUT",data:{value:this.data.toolbar}}).then(function(){this.sandbox.emit("sulu.header.toolbar.item.disable","save",!0),"back"===a?d.toList():"new"===a&&d.toAdd()}.bind(this)).fail(function(){this.sandbox.emit("sulu.header.toolbar.item.enable","save",!0)}.bind(this))},loadComponentData:function(){var a=this.options.data(),c=b.Deferred();return b.getJSON("/admin/api/roles/"+a.get("id")+"/settings/ckeditor-toolbar").then(function(b){a.toolbar=b||this.sandbox.ckeditor.getAvailableToolbar(),c.resolve(a)}.bind(this)),c.promise()}}});