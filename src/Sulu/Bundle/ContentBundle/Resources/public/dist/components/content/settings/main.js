define(["underscore","jquery","config","sulusecurity/components/users/models/user","sulucontact/models/contact","services/husky/url-validator","sulucontent/services/content-manager"],function(a,b,c,d,e,f,g){"use strict";var h=1,i=2,j=4,k={validateErrorClass:"husky-validate-error",internalLink:{titleContainer:"#internal-link-container .title",linkContainer:"#internal-link-container .link"},externalLink:{titleContainer:"#external-link-container .title",linkContainer:"#external-link-container .link"}},l=null,m=function(){return this.sandbox.dom.prop("#shadow_on_checkbox","checked")},n=function(a,b){var c,d=this.sandbox.date.format(b,!0);c=a?this.sandbox.util.sprintf(this.sandbox.translate("sulu.content.form.settings.changelog.created"),{creator:a,created:d}):this.sandbox.util.sprintf(this.sandbox.translate("sulu.content.form.settings.changelog.created-only"),{created:d}),this.sandbox.dom.text("#created",c)},o=function(a,b){var c,d=this.sandbox.date.format(b,!0);c=a?this.sandbox.util.sprintf(this.sandbox.translate("sulu.content.form.settings.changelog.changed"),{changer:a,changed:d}):this.sandbox.util.sprintf(this.sandbox.translate("sulu.content.form.settings.changelog.changed-only"),{changed:d}),this.sandbox.dom.text("#changed",c)},p=function(a,b){var c,d=this.sandbox.date.format(b);a=a||l,a?(l=a,c=this.sandbox.util.sprintf(this.sandbox.translate("sulu.content.form.settings.changelog.authored"),{author:a,authored:d})):c=this.sandbox.util.sprintf(this.sandbox.translate("sulu.content.form.settings.changelog.authored-only"),{authored:d}),this.sandbox.dom.text("#author",c)},q=function(){this.sandbox.dom.show("#changelog-container")};return{layout:function(){return{extendExisting:!0,content:{width:"fixed",leftSpace:!0,rightSpace:!0}}},initialize:function(){this.sandbox.emit("husky.toolbar.header.item.disable","template",!1),this.load(),this.bindCustomEvents()},startComponents:function(){var a,b=this.sandbox.dom.data("#shadow_base_language_select","languages"),c=[],d=null;void 0!==this.data.enabledShadowLanguages[this.options.language]&&(d=this.data.enabledShadowLanguages[this.options.language]),0===b.length?c.push({id:"",name:"no languages",disabled:!0}):this.sandbox.util.each(this.data.concreteLanguages,function(a,b){if(this.options.language!==b){var e=!1;d===b&&(e=!0),c.push({id:b,name:b,disabled:e})}}.bind(this)),a=this.data.shadowBaseLanguage,0===c.length&&(c=[{id:-1,name:this.sandbox.translate("sulu.content.form.settings.shadow.no_base_language"),disabled:!0}]),this.sandbox.start([{name:"select@husky",options:{el:"#shadow_base_language_select",instanceName:"settings",multipleSelect:!1,defaultLabel:this.sandbox.translate("sulu.content.form.settings.shadow.select_base_language"),data:c,preSelectedElements:[a]}}])},bindCustomEvents:function(){this.sandbox.on("sulu.toolbar.save",function(a){this.submit(a)},this);var a=function(){this.sandbox.emit("sulu.content.contents.set-header-bar",!1)}.bind(this);this.sandbox.on("husky.select.nav-contexts.selected.item",a.bind(this)),this.sandbox.on("husky.select.nav-contexts.deselected.item",a.bind(this)),this.sandbox.on("husky.select.settings.selected.item",function(){this.sandbox.emit("sulu.content.changed"),this.sandbox.emit("sulu.content.contents.set-header-bar",!1)}.bind(this)),this.sandbox.on("sulu.header.state.changed",function(a){this.state=a}.bind(this))},bindDomEvents:function(){this.sandbox.dom.on("#content-type-container","change",function(a){var b=this.sandbox.dom.$(a.currentTarget),c=this.sandbox.dom.find(".sub-form",b.parent().parent().parent()),d=this.sandbox.dom.val(b);this.sandbox.dom.hide("#content-type-container .sub-form"),this.sandbox.dom.show(c),parseInt(d)===h||this.data.shadowOn?this.sandbox.dom.show("#shadow-container"):this.sandbox.dom.hide("#shadow-container")}.bind(this),".content-type"),this.sandbox.dom.on("#shadow_on_checkbox","click",function(){this.updateVisibilityForShadowCheckbox(!1)}.bind(this)),this.sandbox.dom.on("#change-author","click",function(){this.openAuthorSelection()}.bind(this))},updateVisibilityForShadowCheckbox:function(a){var b,c=m.call(this),d=this.sandbox.dom.find("#shadow-container .input-description");!1===a&&(b="hide"),"hide"===b?this.sandbox.emit("husky.toolbar.header.item.disable","state",!1):this.sandbox.emit("husky.toolbar.header.item.enable","state",!1),c?(this.sandbox.emit("sulu.content.contents.show-save-items","shadow"),d.show()):(this.sandbox.emit("sulu.content.contents.show-save-items","content"),d.hide()),this.sandbox.util.each(["show-in-navigation-container","settings-content-form-container"],function(a,b){c?this.sandbox.dom.find("#"+b).hide():this.sandbox.dom.find("#"+b).show()}.bind(this))},load:function(){this.sandbox.emit("sulu.content.contents.get-data",function(a){this.render(a)}.bind(this))},render:function(a){this.data=a,require(["text!/admin/content/template/content/settings.html?webspaceKey="+this.options.webspace+"&languageCode="+this.options.language],function(b){this.sandbox.dom.html(this.$el,this.sandbox.util.template(b,{translate:this.sandbox.translate})),this.buildAllNavContexts(this.sandbox.dom.data("#nav-contexts","auraData")),this.bindDomEvents(),this.setData(this.data),this.listenForChange(),this.startComponents(),this.sandbox.start(this.$el,{reset:!0}),this.sandbox.start([{name:"single-internal-link@sulucontent",options:{el:"#internal-link",instanceName:"internal-link",resultKey:"nodes",url:["/admin/api/nodes{/uuid}?depth=1&webspace=",this.options.webspace,"&language=",this.options.language,"&webspace-node=true"].join(""),columnNavigationUrl:["/admin/api/nodes?{id=uuid&}tree=true&webspace=",this.options.webspace,"&language=",this.options.language,"&webspace-node=true"].join(""),disabledIds:[this.data.id]}}]),c.get("sulu-content").versioning.enabled&&this.sandbox.start([{name:"datagrid@husky",options:{el:"#versions",instanceName:"versions",url:["/admin/api/nodes/",this.options.id,"/versions?language=",this.options.language,"&webspace=",this.options.webspace].join(""),resultKey:"versions",actionCallback:this.restoreVersion.bind(this),viewOptions:{table:{actionIcon:"history",actionColumn:"authored",selectItem:!1}},matchings:[{name:"authored",attribute:"authored",content:this.sandbox.translate("sulu-document-manager.version.authored"),type:"datetime"},{name:"author",attribute:"author",content:this.sandbox.translate("sulu-document-manager.version.author")}]}}]),this.updateVisibilityForShadowCheckbox(!0),this.updateChangelog(a)}.bind(this))},buildAllNavContexts:function(a){this.allNavContexts={};for(var b=0,c=a.length;c>b;b++)this.allNavContexts[a[b].id]=a[b].name},updateChangelog:function(a){var b,c,f,g=this.sandbox.data.deferred(),h=this.sandbox.data.deferred(),i=this.sandbox.data.deferred();a.creator===a.changer?(b=new d({id:a.creator}),b.fetch({global:!1,success:function(b){g.resolve(b.get("fullName"),a.created),h.resolve(b.get("fullName"),a.changed)},error:function(){g.resolve(null,a.created),h.resolve(null,a.changed)}.bind(this)})):(b=new d({id:a.creator}),c=new d({id:a.changer}),b.fetch({global:!1,success:function(b){g.resolve(b.get("fullName"),a.created)},error:function(){g.resolve(null,a.created)}.bind(this)}),c.fetch({global:!1,success:function(b){h.resolve(b.get("fullName"),a.changed)},error:function(){h.resolve(null,a.changed)}.bind(this)})),a.author?(f=new e({id:a.author}),f.fetch({global:!1,success:function(b){i.resolve(b.get("fullName"),new Date(a.authored))}.bind(this),error:function(){i.resolve(null,new Date(a.authored))}.bind(this)})):i.resolve(null,new Date(a.authored)),this.sandbox.data.when(g,h,i).then(function(a,b,c){n.call(this,a[0],a[1]),o.call(this,b[0],b[1]),p.call(this,c[0],c[1]),q.call(this)}.bind(this))},setData:function(a){var c=parseInt(a.nodeType);c===h?this.sandbox.dom.attr("#content-node-type","checked",!0).trigger("change"):c===i?this.sandbox.dom.attr("#internal-link-node-type","checked",!0).trigger("change"):c===j&&this.sandbox.dom.attr("#external-link-node-type","checked",!0).trigger("change"),a.title&&(this.sandbox.dom.val("#internal-title",a.title),this.sandbox.dom.val("#external-title",a.title)),a.internal_link&&this.sandbox.dom.data("#internal-link","singleInternalLink",a.internal_link),a.external&&this.sandbox.dom.data("#external","url-data",f.match(a.external)),this.sandbox.on("husky.select.nav-contexts.initialize",function(){var c,d,e=[];for(c=0,d=a.navContexts.length;d>c;c++)e.push(this.allNavContexts[a.navContexts[c]]);this.sandbox.dom.data("#nav-contexts","selection",a.navContexts),this.sandbox.dom.data("#nav-contexts","selectionValues",e),b("#nav-contexts").trigger("data-changed")}.bind(this)),a.shadowOn&&(this.sandbox.dom.attr("#shadow_on_checkbox","checked",!0),this.sandbox.emit("husky.toolbar.header.item.disable","state",!1))},listenForChange:function(){this.sandbox.dom.on(this.$el,"keyup change",function(){this.setHeaderBar(!1)}.bind(this),".trigger-save-button"),this.sandbox.on("sulu.single-internal-link.internal-link.data-changed",function(){this.setHeaderBar(!1)}.bind(this))},setHeaderBar:function(a){this.sandbox.emit("sulu.content.contents.set-header-bar",a)},submit:function(a){this.sandbox.logger.log("save Model");var b={},c=this.sandbox.dom.data("#shadow_base_language_select","selectionValues");if(b.id=this.data.id,b.navContexts=this.sandbox.dom.data("#nav-contexts","selection"),b.nodeType=parseInt(this.sandbox.dom.val('input[name="nodeType"]:checked')),b.shadowOn=m.call(this),b.shadowBaseLanguage=null,this.state&&(b.state=this.state),b.nodeType===i)b.title=this.sandbox.dom.val("#internal-title"),b.internal_link=this.sandbox.dom.data("#internal-link","singleInternalLink");else if(b.nodeType===j){var d=this.sandbox.dom.data("#external","url-data");b.title=this.sandbox.dom.val("#external-title"),b.external=d.scheme+d.specificPart,b.urlParts=d}return b.shadowOn&&c&&c.length>0&&(b.shadowBaseLanguage=c[0]),b.author=this.data.author,b.authored=this.data.authored,this.validate(b)?(this.sandbox.emit("sulu.header.toolbar.item.loading","save"),void g.save(b,this.options.language,this.options.webspace,{action:a},function(b){this.sandbox.emit("sulu.content.contents.saved",b.id,b,a),this.sandbox.emit("husky.datagrid.versions.update")}.bind(this),function(a){this.sandbox.emit("sulu.content.contents.error",a.status,b)}.bind(this))):void this.sandbox.emit("sulu.labels.warning.show","form.validation-warning","labels.warning")},restoreVersion:function(a,b){this.sandbox.sulu.showConfirmationDialog({callback:function(c){return c?(this.sandbox.emit("husky.overlay.alert.show-loader"),g.restoreVersion(this.options.id,a,b.locale,this.options.webspace).always(function(){this.sandbox.emit("husky.overlay.alert.hide-loader")}.bind(this)).then(function(){this.sandbox.emit("husky.overlay.alert.close"),this.sandbox.emit("sulu.router.navigate",["content/contents/",this.options.webspace,"/",this.options.language,"/edit:",this.options.id,"/content"].join(""),!0,!0)}.bind(this)).fail(function(){this.sandbox.emit("sulu.labels.error.show","sulu.content.restore-error-description","sulu.content.restore-error-title")}.bind(this)),!1):void 0}.bind(this),title:this.sandbox.translate("sulu-document-manager.restore-confirmation-title"),description:this.sandbox.translate("sulu-document-manager.restore-confirmation-description")})},validate:function(a){return this.sandbox.dom.removeClass(k.internalLink.titleContainer,k.validateErrorClass),this.sandbox.dom.removeClass(k.internalLink.linkContainer,k.validateErrorClass),this.sandbox.dom.removeClass(k.externalLink.titleContainer,k.validateErrorClass),this.sandbox.dom.removeClass(k.externalLink.linkContainer,k.validateErrorClass),a.nodeType===i?this.validateInternal(a):a.nodeType===j?this.validateExternal(a):!0},validateInternal:function(a){var b=!0;return a.title||(b=!1,this.sandbox.dom.addClass(k.internalLink.titleContainer,k.validateErrorClass)),a.internal_link||(b=!1,this.sandbox.dom.addClass(k.internalLink.linkContainer,k.validateErrorClass)),b},validateExternal:function(a){var b=!0;return a.title||(b=!1,this.sandbox.dom.addClass(k.externalLink.titleContainer,k.validateErrorClass)),a.urlParts.scheme&&a.urlParts.specificPart||(b=!1,this.sandbox.dom.addClass(k.externalLink.linkContainer,k.validateErrorClass)),b},openAuthorSelection:function(){var a=b("<div/>"),c=b("<div/>");this.$el.append(a),this.sandbox.start([{name:"overlay@husky",options:{el:a,instanceName:"author-selection",openOnStart:!0,removeOnClose:!0,skin:"medium",slides:[{title:this.sandbox.translate("sulu.content.form.settings.author"),okCallback:function(){this.sandbox.emit("sulu.content.contents.get-author")}.bind(this),data:c}]}}]),this.sandbox.once("husky.overlay.author-selection.initialized",function(){this.sandbox.start([{name:"content/settings/author-selection@sulucontent",options:{el:c,locale:this.options.locale,data:{author:this.data.author,authored:this.data.authored},selectCallback:function(a){this.setAuthor(a),this.sandbox.emit("husky.overlay.author-selection.close")}.bind(this)}}])}.bind(this))},setAuthor:function(a){return this.setHeaderBar(!1),this.data.authored=a.authored,a.authorItem?(p.call(this,a.authorItem.firstName+" "+a.authorItem.lastName,new Date(a.authored)),void(this.data.author=a.author)):void p.call(this,null,new Date(a.authored))}}});