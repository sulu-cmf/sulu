define(["services/husky/util","services/sulucontent/user-settings-manager"],function(a,b){"use strict";var c={options:{instanceName:"categories",preselectedOperator:"or",preselectedCategories:[],root:null,locale:null},translations:{operatorLabel:"smart-content.categories.operator-label",categoriesLabel:"smart-content.categories.categories-label",useAnyCategory:"smart-content.categories.use-any-category",useAllCategories:"smart-content.categories.use-all-categories",noCategoriesAvailable:"sulu.category.no-categories-available"},templates:{skeleton:['<div class="form-group m-bottom-20">',"   <label><%=operatorLabel%></label>",'   <div class="<%=constants.operatorClass%>"></div>',"</div>",'<div class="form-group">',"   <label><%=categoriesLabel%></label>",'   <div class="<%=constants.categoriesClass%> categories-container"></div>',"</div>"].join("")}},d={or:"or",and:"and"},e={operatorClass:"operator",categoriesClass:"categories"},f="smart-content.categories.";return{defaults:c,events:{names:{initialized:{postFix:"initialized"},getData:{postFix:"get-data",type:"on"}},namespace:f},data:{ids:c.preselectedCategories,items:[],operator:c.preselectedOperator},initialize:function(){this.data={ids:this.options.preselectedCategories,items:[],operator:this.options.preselectedOperator},this.render(),this.initComponents(),this.bindCustomEvents()},render:function(){this.$el.html(this.templates.skeleton({constants:e,operatorLabel:this.translations.operatorLabel,categoriesLabel:this.translations.categoriesLabel}))},initComponents:function(){this.sandbox.start([{name:"select@husky",options:{el:this.$find("."+e.operatorClass),instanceName:this.options.instanceName,value:"name",data:[{id:d.or,name:this.translations.useAnyCategory},{id:d.and,name:this.translations.useAllCategories}],preSelectedElements:[d[this.data.operator]]}},{name:"datagrid@husky",options:{el:this.$find("."+e.categoriesClass),instanceName:this.options.instanceName,url:["/admin/api/categories","?locale=",this.options.locale,this.options.root?"&rootKey="+this.options.root:"","&flat=true&sortBy=name&sortOrder=asc"].join(""),resultKey:"categories",pagination:!1,childrenPropertyName:"hasChildren",resizeListener:!1,selectedCounter:!0,preselected:this.data.ids,viewOptions:{table:{cropContents:!1,noItemsText:this.translations.noCategoriesAvailable,showHead:!1,cssClass:"white-box",selectItem:{type:"checkbox",inFirstCell:!0}}},matchings:[{name:"name",content:"Name"},{name:"id",disabled:!0},{name:"children",disabled:!0},{name:"parent",disabled:!0}]}}]).then(function(){this.sandbox.once(this.sandbox.events.createEventName("husky.datagrid.","view.rendered",this.options.instanceName),this.sandbox.emit.bind(this,this.sandbox.events.createEventName("husky.datagrid.","items.get-selected",this.options.instanceName),this.setSelected.bind(this),!0))}.bind(this))},bindCustomEvents:function(){this.sandbox.on(this.sandbox.events.createEventName("husky.datagrid.","item.select",this.options.instanceName),this.add.bind(this)),this.sandbox.on(this.sandbox.events.createEventName("husky.datagrid.","item.deselect",this.options.instanceName),this.removeItem.bind(this)),this.sandbox.on(this.sandbox.events.createEventName("husky.select.","selected.item",this.options.instanceName),this.selectOperator.bind(this)),this.events.getData(function(a){a(this.getData())}.bind(this))},add:function(a,b){this.data.ids.indexOf(a)>-1||(this.data.ids.push(a),this.data.items.push(b))},removeItem:function(a){var b=this.data.ids.indexOf(a);b>-1&&(this.data.ids.splice(b,1),this.data.items.splice(b,1))},selectOperator:function(a){this.data.operator=a},setSelected:function(b,c){this.data.ids=a.deepCopy(b),this.data.items=a.deepCopy(c),this.events.initialized(this.data)},getData:function(){return this.data}}});