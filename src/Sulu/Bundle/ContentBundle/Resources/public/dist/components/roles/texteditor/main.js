define(["underscore","jquery","config","text!./skeleton.html"],function(a,b,c,d){"use strict";return{defaults:{options:{},translations:{title:"sulu-content.ckeditor.roles-title",all:"security.roles.all",none:"security.roles.none",type:"sulu-content.ckeditor.roles-type",horizontal:"sulu-content.ckeditor.roles-horizontal",info:"sulu-content.ckeditor.roles-info",warning:"security.warning"},templates:{skeleton:d}},initialize:function(){this.toolbar=this.sandbox.ckeditor.getAvailableToolbarSections(),this.render(),this.bindDOMEvents(),this.bindCustomEvents()},bindDOMEvents:function(){this.sandbox.dom.on("#select-all","click",function(){this.sandbox.emit("husky.matrix.set-all")}.bind(this))},bindCustomEvents:function(){this.sandbox.on("husky.matrix.changed",this.changeData.bind(this)),this.sandbox.on("husky.matrix.changed",function(){this.sandbox.emit("sulu.tab.dirty")}.bind(this)),this.sandbox.on("sulu.tab.save",this.save.bind(this))},render:function(){var a=this.prepareMatrixValues(),b=this.prepareMatrixData();this.$el.html(this.templates.skeleton({translations:this.translations,content:this.data.role})),this.sandbox.start([{name:"matrix@husky",options:{el:"#matrix-container",captions:{all:this.translations.all,none:this.translations.none,type:this.translations.type,horizontal:this.translations.horizontal,vertical:a.vertical},values:a,data:b}}])},prepareMatrixValues:function(){var b=[],c=[];for(var d in this.toolbar)this.toolbar.hasOwnProperty(d)&&(b.push(d),c.push(a.map(this.toolbar[d],function(a){return{value:a,icon:this.sandbox.ckeditor.getIcon(a),title:a}}.bind(this))));return{vertical:b,horizontal:c}},prepareMatrixData:function(){var b=[];for(var c in this.toolbar)b.push(a.map(this.toolbar[c],function(b){return a.contains(this.data.toolbarRights[c],b)}.bind(this)));return b},changeData:function(a){"string"!=typeof a.value?this.sandbox.dom.each(a.value,function(b,c){this.changeDataForElement({section:a.section,value:c.value,activated:a.activated})}.bind(this)):this.changeDataForElement(a)},changeDataForElement:function(b){if(b.activated){if(a.contains(this.data.toolbarRights[b.section],b.value))return;this.data.toolbarRights[b.section]||(this.data.toolbarRights[b.section]=[]),this.data.toolbarRights[b.section].push(b.value)}else{var c=this.data.toolbarRights[b.section].indexOf(b.value);c>-1&&this.data.toolbarRights[b.section].splice(c,1)}},save:function(){this.sandbox.emit("sulu.tab.saving"),b.ajax("/admin/api/roles/"+this.data.role.id+"/settings/texteditor-toolbar",{method:"PUT",data:{value:this.data.toolbarRights}}).then(function(){this.sandbox.emit("sulu.tab.saved")}.bind(this))},loadComponentData:function(){var a=this.options.data(),c=b.Deferred();return b.getJSON("/admin/api/roles/"+a.id+"/settings/texteditor-toolbar").then(function(d){var e=d||this.sandbox.ckeditor.getAvailableToolbarSections();b.isArray(e)&&0===e.length&&(e={}),c.resolve({role:a,toolbarRights:e})}.bind(this)),c.promise()}}});