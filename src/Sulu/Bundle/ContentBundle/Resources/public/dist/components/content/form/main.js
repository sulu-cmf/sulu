define(["app-config","config","services/sulupreview/preview"],function(a,b,c){"use strict";return{tabOptions:{noTitle:!0},layout:function(){return{extendExisting:!0,content:{width:this.options.preview?"fixed":"max",rightSpace:!1,leftSpace:!1}}},template:"",whenResourceLocatorIsLoaded:$.Deferred(),saved:!0,animateTemplateDropdown:!1,initialize:function(){this.sandbox.emit("husky.toolbar.header.item.enable","template",!1),this.load()},bindCustomEvents:function(){this.sandbox.on("sulu.dropdown.template.item-clicked",function(a){this.animateTemplateDropdown=!0,this.checkRenderTemplate(a,!0)},this),this.sandbox.on("sulu.toolbar.save",function(a){"publish"==a?app.sandbox.sulu.showConfirmationDialog({callback:function(b){b&&this.submit(a)}.bind(this),title:"sulu.overlay.publish",description:"sulu.overlay.publish-desc"}):this.submit(a)},this),this.sandbox.on("sulu.content.navigate",this.navigate,this),this.sandbox.on("sulu.header.saved",function(a){this.data=a,this.initializeResourceLocator()},this)},initializeResourceLocator:function(){this.data.url?(this.sandbox.dom.off(this.getDomElementsForTagName("sulu.rlp.part"),".resourcelocator"),this.whenResourceLocatorIsLoaded.resolve()):(this.sandbox.dom.on(this.getDomElementsForTagName("sulu.rlp.part"),"change.resourcelocator",function(){this.whenResourceLocatorIsLoaded&&"resolved"!==this.whenResourceLocatorIsLoaded.state()||(this.whenResourceLocatorIsLoaded=$.Deferred())}.bind(this)),this.sandbox.dom.on(this.getDomElementsForTagName("sulu.rlp.part"),"focusout.resourcelocator",this.loadResourceLocator.bind(this)),this.getDomElementsForTagName("sulu.rlp",function(a){a.$el.data("user-edited",!1),this.sandbox.dom.on(a.$el,"change",function(){a.$el.data("user-edited",a.$el.data("element").getValue().length>1)}.bind(this))}.bind(this)))},load:function(){this.sandbox.emit("sulu.content.contents.get-data",this.render.bind(this))},reloadData:function(a){this.sandbox.emit("sulu.content.contents.get-data",this.rerender.bind(this),!0,a)},render:function(a,b){this.bindCustomEvents(),this.listenForChange(),this.preview=b,this.data=a,this.data.template?this.checkRenderTemplate(this.data.template):this.checkRenderTemplate(),this.sandbox.emit("sulu.content.contents.show-save-items","content")},rerender:function(a,b){this.preview=b,this.data=a,this.loadFormTemplate(a.template)},checkRenderTemplate:function(a,b){return"string"==typeof a&&(a={template:a}),a&&this.template===a.template?void this.sandbox.emit("sulu.header.toolbar.item.enable","template",!1):(this.sandbox.emit("sulu.header.toolbar.item.loading","template"),void(""===this.template||this.saved?this.options.id&&b?this.reloadData(a.template):this.loadFormTemplate(a):this.showRenderTemplateDialog(a)))},showRenderTemplateDialog:function(a){this.sandbox.emit("sulu.overlay.show-warning","sulu.overlay.be-careful","content.template.dialog.content",function(){this.sandbox.emit("sulu.header.toolbar.item.enable","template",!1),this.template&&this.sandbox.emit("sulu.header.toolbar.item.change","template",this.template)}.bind(this),function(){this.reloadData(a.template)}.bind(this))},loadFormTemplate:function(a){var b,c;"string"==typeof a&&(a={template:a}),a&&(this.template=a.template),this.formId="#content-form-container",this.$container=this.sandbox.dom.createElement('<div id="content-form-container"/>'),this.html(this.$container),this.sandbox.form.getObject(this.formId)&&(b=this.data,this.data=this.sandbox.form.getData(this.formId),b.id&&(this.data.id=b.id),this.data=this.sandbox.util.extend({},b,this.data)),c=this.getTemplateUrl(a),require([c],function(a){this.renderFormTemplate(a)}.bind(this))},renderFormTemplate:function(a){var c={translate:this.sandbox.translate,content:this.data,options:this.options},d=this.sandbox.util.extend({},c,{categoryLocale:this.options.language}),e=this.sandbox.util.template(a,d);this.sandbox.dom.html(this.formId,e),this.setStateDropdown(this.data),this.propertyConfiguration={},this.createForm(this.data).then(function(){this.initializeResourceLocator(),this.changeTemplateDropdownHandler(),this.preview&&this.preview.bindDomEvents(this.$el),b.has("sulu-collaboration")&&this.startCollaborationComponent()}.bind(this))},createForm:function(a){var b=this.sandbox.form.create(this.formId),c=this.sandbox.data.deferred();return b.initialized.then(function(){this.createConfiguration(this.formId),this.setFormData(a).then(function(){this.sandbox.start(this.$el,{reset:!0}).then(function(){this.initSortableBlock(),this.bindFormEvents();var a=this.sandbox.form.getData(this.formId);this.sandbox.emit("sulu.content.initialized",a),c.resolve(),this.preview&&this.preview.updateContext({template:this.template},a)}.bind(this))}.bind(this))}.bind(this)),c.promise()},createConfiguration:function(a){var b=this.sandbox.dom.find("*[data-property]",a);this.sandbox.dom.each(b,function(a,b){var c=this.sandbox.dom.data(b,"property");c.$el=this.sandbox.dom.$(b),this.sandbox.dom.data(b,"property",null),this.sandbox.dom.removeAttr(b,"data-property",null),this.sandbox.util.foreach(c.tags,function(a){this.propertyConfiguration[a.name]?(this.propertyConfiguration[a.name].properties[a.priority]?this.propertyConfiguration[a.name].properties[a.priority].push(c):this.propertyConfiguration[a.name].properties[a.priority]=[c],this.propertyConfiguration[a.name].highestPriority<a.priority&&(this.propertyConfiguration[a.name].highestProperty=c,this.propertyConfiguration[a.name].highestPriority=a.priority),this.propertyConfiguration[a.name].lowestPriority>a.priority&&(this.propertyConfiguration[a.name].lowestProperty=c,this.propertyConfiguration[a.name].lowestPriority=a.priority)):(this.propertyConfiguration[a.name]={properties:{},highestProperty:c,highestPriority:a.priority,lowestProperty:c,lowestPriority:a.priority},this.propertyConfiguration[a.name].properties[a.priority]=[c])}.bind(this))}.bind(this))},initSortableBlock:function(){var a,b=this.sandbox.dom.find(".sortable",this.$el);b&&b.length>0&&(this.sandbox.dom.sortable(b,"destroy"),a=this.sandbox.dom.sortable(b,{handle:".move",forcePlaceholderSize:!0}),this.sandbox.dom.unbind(a,"sortupdate"),a.bind("sortupdate",function(a){var b=this.sandbox.form.getData(this.formId),c=this.sandbox.dom.data(a.currentTarget,"mapperProperty");this.preview&&this.preview.updateProperty(c,b[c]),this.sandbox.emit("sulu.content.changed")}.bind(this)))},bindFormEvents:function(){this.sandbox.dom.on(this.formId,"form-remove",function(a,b){var c=this.sandbox.form.getData(this.formId);this.initSortableBlock(),this.preview&&this.preview.updateProperty(b,c[b]),this.setHeaderBar(!1)}.bind(this)),this.sandbox.dom.on(this.formId,"form-add",function(a,b,c,d){this.createConfiguration(a.currentTarget);var e,f=this.sandbox.dom.children(this.$find('[data-mapper-property="'+b+'"]')),g=void 0!==d&&f.length>d?f[d]:this.sandbox.dom.last(f);this.sandbox.start(g);try{e=this.sandbox.form.getData(this.formId),this.preview&&this.preview.updateProperty(b,e[b])}catch(h){}this.setHeaderBar(!1),this.initSortableBlock()}.bind(this)),this.sandbox.dom.on(this.formId,"init-sortable",function(a){this.initSortableBlock()}.bind(this))},setFormData:function(a){var b=this.sandbox.form.setData(this.formId,a),c="title";return!a.id||""!==a[c]&&"undefined"!=typeof a[c]&&null!==a[c]||this.sandbox.util.load("/admin/api/nodes/"+a.id+"?webspace="+this.options.webspace+"&language="+this.options.language+"&complete=false&ghost-content=true").then(function(a){a.type&&this.sandbox.dom.attr("#title","placeholder",a.type.value+": "+a[c])}.bind(this)),this.sandbox.dom.attr("#show-in-navigation","checked",a.navigation),b},getDomElementsForTagName:function(a,b){var c,d=$();if(this.propertyConfiguration.hasOwnProperty(a))for(c in this.propertyConfiguration[a].properties)this.propertyConfiguration[a].properties.hasOwnProperty(c)&&this.sandbox.util.foreach(this.propertyConfiguration[a].properties[c],function(a){$.merge(d,a.$el),b&&b(a)});return d},getTemplateUrl:function(a){var b="text!/admin/content/template/form";return b+=a?"/"+a.template+".html":".html",b+="?webspace="+this.options.webspace+"&language="+this.options.language,this.data.id&&(b+="&uuid="+this.data.id),b},setHeaderBar:function(a){this.sandbox.emit("sulu.content.contents.set-header-bar",a),this.saved=a},setStateDropdown:function(a){this.sandbox.emit("sulu.content.contents.set-state",a)},loadResourceLocator:function(){var a=this.getNonEmptyRlpParts();this.sandbox.emit("sulu.content.contents.get-rl",a,this.setResourceLocator.bind(this))},getNonEmptyRlpParts:function(){var a,b,d={};return this.getDomElementsForTagName("sulu.rlp.part",function(e){a=e.$el.data("element").getValue(),""!==a&&(b=c.getSequence(e.$el),b&&(d[b]=a))}.bind(this)),d},setResourceLocator:function(a){this.getDomElementsForTagName("sulu.rlp",function(b){b.$el.data("user-edited")||b.$el.data("element").setValue(a)}.bind(this)),this.whenResourceLocatorIsLoaded.resolve(),this.setHeaderBar(!1)},areRlpPartsValid:function(){var a=!0;return this.getDomElementsForTagName("sulu.rlp.part",function(b){b.$el.data("element").validate()||(a=!1)}.bind(this)),a},listenForChange:function(){this.sandbox.dom.on(this.$el,"keyup change",_.debounce(function(){this.setHeaderBar(!1)}.bind(this),10),".trigger-save-button"),this.sandbox.on("sulu.content.changed",function(){this.setHeaderBar(!1)}.bind(this))},changeTemplateDropdownHandler:function(){this.template&&this.sandbox.emit("sulu.header.toolbar.item.change","template",this.template),this.sandbox.emit("sulu.header.toolbar.item.enable","template",this.animateTemplateDropdown),this.animateTemplateDropdown=!1},submit:function(a){this.areRlpPartsValid()&&this.whenResourceLocatorIsLoaded.then(function(){if(this.sandbox.form.validate(this.formId)){this.sandbox.emit("sulu.header.toolbar.item.loading","save");var b=this.sandbox.form.getData(this.formId);b.navigation=this.sandbox.dom.prop("#show-in-navigation","checked"),this.sandbox.emit("sulu.content.contents.save",b,a)}}.bind(this))},startCollaborationComponent:function(){if(this.options.id){var b=this.sandbox.dom.createElement('<div id="content-column-collaboration"/>');this.$el.prepend(b),this.sandbox.start([{name:"collaboration@sulucollaboration",options:{el:b,id:this.options.id,webspace:this.options.webspace,userId:a.getUser().id,type:"page"}}])}},navigate:function(a){var b=function(a){this.sandbox.emit("sulu.router.navigate",a)}.bind(this);this.saved?b.call(this,a):this.sandbox.emit("sulu.overlay.show-warning","sulu.overlay.be-careful","content.template.dialog.content",function(){},function(){b.call(this,a)}.bind(this))}}});