define(["app-config","config"],function(a,b){"use strict";var c={filterListUrl:"resource/filters/",manageFilters:"manage",filtersUrl:"api/filters?locale={locale}&flat=true&limit=100&context=",filterUrl:"resource/filters/",toolbarSelectButtonId:"filters"},d=function(a,b,d,g,i){if(a&&b&&g&&this.config.contexts[a]){var j=c.filtersUrl+a,k="husky.datagrid."+g+".updated",l="husky.datagrid."+g+".loading.failed",m=h.call(this,a,g,j);this.filterResultSelector=i,this.context=a,this.datagridInstance=g,this.toolbarInstanceName=d,b.push(m),this.sandbox.off(k),this.sandbox.on(k,e.bind(this)),this.sandbox.on(l,f.bind(this))}},e=function(a){if(this.filter&&a)if(this.filterResultComponentStarted){var b=i.call(this);this.sandbox.emit("sulu.filter-result."+this.context+".update",a.total,this.filter,b)}else this.filterResultComponentStarted=!0,App.start([{name:"filter-result@suluresource",options:{el:this.filterResultSelector,filter:this.filter,datagridInstance:this.datagridInstance,numberOfResults:a.total,filterUrl:i.call(this),instanceName:this.context}}]).then(function(){this.sandbox.off("sulu.filter-result."+this.context+".unset_filter"),this.sandbox.on("sulu.filter-result."+this.context+".unset_filter",g.bind(this))}.bind(this));else this.sandbox.logger.log("Either no filter is set or the result contains no total number!")},f=function(){this.sandbox.emit("sulu.labels.error.show",this.sandbox.translate("resource.filter.error-loading"),"labels.error",""),this.sandbox.emit("husky.datagrid."+this.datagridInstance+".url.update",{filter:""}),g.call(this)},g=function(){this.sandbox.emit("husky.toolbar."+this.toolbarInstanceName+".item.reset",c.toolbarSelectButtonId),this.filter=null,l.call(this,null,this.datagridInstance)},h=function(a,b,d){return d=d.replace("{locale}",this.sandbox.sulu.getDefaultContentLocale()),{id:c.toolbarSelectButtonId,icon:"filter",title:this.sandbox.translate("resource.filter"),group:2,dropdownOptions:{url:d,resultKey:"filters",titleAttribute:"name",idAttribute:"id",markSelected:!0,preSelected:this.filter?parseInt(this.filter.id):null,callback:function(d){n.call(this,d,b,a),this.sandbox.emit("husky.toolbar."+b+".item.change",c.toolbarSelectButtonId,d.id)}.bind(this)},dropdownItems:[{divider:!0},{id:c.manageFilters,name:this.sandbox.translate("resource.filter.manage")}]}},i=function(){return c.filterUrl+this.context+"/"+this.sandbox.sulu.getDefaultContentLocale()+"/edit:"+this.filter.id+"/edit"},j=function(){this.filter=null,this.filterResultComponentStarted=!1,this.filterResultSelector&&App.stop(this.filterResultSelector)},k=function(a){return a+"Filter"},l=function(a,b){a?this.sandbox.sulu.saveUserSetting(k.call(this,b),a):this.sandbox.sulu.deleteUserSetting(k.call(this,b))},m=function(a){var b=k.call(this,a.instanceName),c=a.url,d=this.sandbox.sulu.getUserSetting(b);d&&d.id&&-1===c.indexOf("filter")&&(c+=c.indexOf("?")>-1?"&":"?",this.filter=d,a.url=c+"filter="+d.id,this.sandbox.once("husky.datagrid."+a.instanceName+".loaded",e.bind(this)))},n=function(a,b,d){a.id!==c.manageFilters?(this.filter=a,this.filterUrl=i.call(this),this.sandbox.emit("husky.datagrid."+b+".url.update",{filter:a.id}),l.call(this,a,b)):(this.filter=null,this.filterUrl=null,this.sandbox.emit("sulu.router.navigate",c.filterListUrl+d))};return{initialize:function(a){a.components.before("initialize",function(){"Sulu App"===this.name&&(this.config=b.get("sulu.resource.contexts"),this.config.contexts&&"object"===this.sandbox.util.typeOf(this.config.contexts)&&(this.sandbox.on("sulu.list-toolbar.extend",d.bind(this)),this.sandbox.on("sulu.router.navigate",j.bind(this)),this.sandbox.on("sulu.list.preload",m.bind(this))))})}}});