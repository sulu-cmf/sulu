define(["app-config","config","filtersutil/filter"],function(a,b,c){"use strict";var d={filterListUrl:"resource/filters/",manageFilters:"manage",filtersUrl:"api/filters?flat=true&context=",filterUrl:"resource/filters/",toolbarSelectButtonId:"filters"},e=function(a,b,c,e,g){if(a&&b&&e&&this.config.contexts[a]){var i=d.filtersUrl+a,j="husky.datagrid."+e+".updated",k=h.call(this,a,e,i);this.filterResultSelector=g,this.context=a,this.datagridInstance=e,this.toolbarInstanceName=c,b.push(k),this.sandbox.off(j),this.sandbox.on(j,f.bind(this))}},f=function(a){if(this.filter&&a&&a.total)if(this.filterResultComponentStarted){var b=i.call(this);this.sandbox.emit("sulu.filter-result."+this.context+".update",a.total,this.filter,b)}else this.filterResultComponentStarted=!0,App.start([{name:"filter-result@suluresource",options:{el:this.filterResultSelector,filter:this.filter,datagridInstance:this.datagridInstance,numberOfResults:a.total,filterUrl:i.call(this),instanceName:this.context}}]).then(function(){this.sandbox.off("sulu.filter-result."+this.context+".unset_filter"),this.sandbox.on("sulu.filter-result."+this.context+".unset_filter",g.bind(this))}.bind(this));else this.sandbox.logger.log("Either no filter is set or the result contains no total number!")},g=function(){this.sandbox.emit("husky.toolbar."+this.toolbarInstanceName+".item.unmark",this.filter.id),this.filter=null,k.call(this,null)},h=function(a,b,c){return{id:d.toolbarSelectButtonId,icon:"filter",title:this.sandbox.translate("resource.filter"),group:2,position:1,"class":"highlight-white",type:"select",itemsOption:{url:c,resultKey:"filters",titleAttribute:"name",idAttribute:"id",preSelected:this.filter?parseInt(this.filter.id):null,translate:!1,languageNamespace:"toolbar.",markable:!0,callback:function(c){m.call(this,c,b,a)}.bind(this)},items:[{divider:!0},{id:d.manageFilters,name:this.sandbox.translate("resource.filter.manage")}]}},i=function(){return d.filterUrl+this.context+"/"+a.getUser().locale+"/edit:"+this.filter.id+"/edit"},j=function(){this.filter=null,this.filterResultComponentStarted=!1,this.filterResultSelector&&App.stop(this.filterResultSelector)},k=function(a,b){if(a){var d=c.getFilterSettingValue(a);this.sandbox.sulu.saveUserSetting(c.getFilterSettingKey.call(this,b),d)}else this.sandbox.sulu.deleteUserSetting(c.getFilterSettingKey.call(this,b))},l=function(a,b){var d=c.getFilterSettingKey.call(this,b),e=a.url,g=this.sandbox.sulu.getUserSetting(d);g&&g.id&&-1===e.indexOf("filter")&&(e+=e.indexOf("?")>-1?"&":"?",this.filter=g,a.url=e+"filter="+g.id,this.sandbox.once("husky.datagrid."+a.instanceName+".loaded",f.bind(this)))},m=function(a,b,c){a.id!==d.manageFilters?(this.filter=a,this.filterUrl=i.call(this),this.sandbox.emit("husky.datagrid."+b+".url.update",{filter:a.id}),k.call(this,a,c)):(this.filter=null,this.filterUrl=null,this.sandbox.emit("sulu.router.navigate",d.filterListUrl+c))};return{initialize:function(a){a.components.before("initialize",function(){"Sulu App"===this.name&&(this.config=b.get("sulu.resource.contexts"),this.config.contexts&&"object"===this.sandbox.util.typeOf(this.config.contexts)&&(this.sandbox.on("sulu.header.toolbar.extend",e.bind(this)),this.sandbox.on("sulu.router.navigate",j.bind(this)),this.sandbox.on("sulu.list.preload",l.bind(this))))})}}});