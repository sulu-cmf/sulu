define(["app-config","config"],function(a,b){"use strict";var c={filterListUrl:"resource/filters/",manageFilters:"manage",filtersUrl:"api/filters?flat=true&context=",filterUrl:"resource/filters/",toolbarSelectButtonId:"filters"},d=function(a,b,d,f,h){if(a&&b&&f&&this.config.contexts[a]){var i=c.filtersUrl+a,j="husky.datagrid."+f+".updated",k=g.call(this,a,f,i);this.filterResultSelector=h,this.context=a,this.datagridInstance=f,this.toolbarInstanceName=d,b.push(k),this.sandbox.off(j),this.sandbox.on(j,e.bind(this))}},e=function(a){if(this.filter&&a&&a.total)if(this.filterResultComponentStarted){var b=h.call(this);this.sandbox.emit("sulu.filter-result."+this.context+".update",a.total,this.filter,b)}else this.filterResultComponentStarted=!0,App.start([{name:"filter-result@suluresource",options:{el:this.filterResultSelector,filter:this.filter,datagridInstance:this.datagridInstance,numberOfResults:a.total,filterUrl:h.call(this),instanceName:this.context}}]).then(function(){this.sandbox.off("sulu.filter-result."+this.context+".unset_filter"),this.sandbox.on("sulu.filter-result."+this.context+".unset_filter",f.bind(this))}.bind(this));else this.sandbox.logger.log("Either no filter is set or the result contains no total number!")},f=function(){this.sandbox.emit("husky.toolbar."+this.toolbarInstanceName+".item.unmark",this.filter.id),this.filter=null,k.call(this,null,this.datagridInstance)},g=function(a,b,d){return{id:c.toolbarSelectButtonId,icon:"filter",title:this.sandbox.translate("resource.filter"),group:2,dropdownOptions:{url:d,resultKey:"filters",titleAttribute:"name",idAttribute:"id",markSelected:!0,preSelected:this.filter?parseInt(this.filter.id):null,callback:function(c){m.call(this,c,b,a)}.bind(this)},dropdownItems:[{divider:!0},{id:c.manageFilters,name:this.sandbox.translate("resource.filter.manage")}]}},h=function(){return c.filterUrl+this.context+"/"+a.getUser().locale+"/edit:"+this.filter.id+"/edit"},i=function(){this.filter=null,this.filterResultComponentStarted=!1,this.filterResultSelector&&App.stop(this.filterResultSelector)},j=function(a){return a+"Filter"},k=function(a,b){a?this.sandbox.sulu.saveUserSetting(j.call(this,b),a):this.sandbox.sulu.deleteUserSetting(j.call(this,b))},l=function(a){var b=j.call(this,a.instanceName),c=a.url,d=this.sandbox.sulu.getUserSetting(b);d&&d.id&&-1===c.indexOf("filter")&&(c+=c.indexOf("?")>-1?"&":"?",this.filter=d,a.url=c+"filter="+d.id,this.sandbox.once("husky.datagrid."+a.instanceName+".loaded",e.bind(this)))},m=function(a,b,d){a.id!==c.manageFilters?(this.filter=a,this.filterUrl=h.call(this),this.sandbox.emit("husky.datagrid."+b+".url.update",{filter:a.id}),k.call(this,a,b)):(this.filter=null,this.filterUrl=null,this.sandbox.emit("sulu.router.navigate",c.filterListUrl+d))};return{initialize:function(a){a.components.before("initialize",function(){"Sulu App"===this.name&&(this.config=b.get("sulu.resource.contexts"),this.config.contexts&&"object"===this.sandbox.util.typeOf(this.config.contexts)&&(this.sandbox.on("sulu.header.toolbar.extend",d.bind(this)),this.sandbox.on("sulu.router.navigate",i.bind(this)),this.sandbox.on("sulu.list.preload",l.bind(this))))})}}});