define(["services/sulucontact/account-manager","sulucontact/models/account","sulucontact/models/contact","sulucontact/models/accountContact","sulucontact/models/email","sulucontact/models/emailType","sulumedia/model/media","sulucategory/model/category","services/sulucontact/account-delete-dialog"],function(a,b,c,d,e,f,g,h,i){"use strict";return{initialize:function(){this.bindCustomEvents(),this.bindSidebarEvents(),this.account=null,this.renderByDisplay()},renderByDisplay:function(){if("list"===this.options.display)this.renderList();else{if("edit"!==this.options.display)throw"display type wrong";this.renderEdit()}},bindCustomEvents:function(){this.sandbox.on("sulu.contacts.account.delete",this.del.bind(this)),this.sandbox.on("sulu.contacts.accounts.save",this.save.bind(this)),this.sandbox.on("sulu.contacts.accounts.load",this.load.bind(this)),this.sandbox.on("sulu.contacts.contact.load",this.loadContact.bind(this)),this.sandbox.on("sulu.contacts.accounts.new",this.add.bind(this)),this.sandbox.on("sulu.contacts.accounts.delete",this.delAccounts.bind(this)),this.sandbox.on("sulu.contacts.accounts.contact.save",this.addAccountContact.bind(this)),this.sandbox.on("sulu.contacts.accounts.contacts.remove",this.removeAccountContacts.bind(this)),this.sandbox.on("sulu.contacts.accounts.contacts.set-main",this.setMainContact.bind(this)),this.sandbox.on("sulu.contacts.accounts.list",this.navigateToList.bind(this)),this.sandbox.on("sulu.contacts.accounts.medias.save",this.saveDocuments.bind(this)),this.sandbox.on("sulu.contacts.accounts.new.contact",this.createNewContact.bind(this))},navigateToList:function(a,b){this.sandbox.emit("sulu.router.navigate","contacts/accounts",!b,!0,!0)},createNewContact:function(a){var b=new c(a);b.set("emails",[new e({email:a.email,emailType:f.findOrCreate({id:this.emailTypes[0].id})})]),b.save(null,{success:function(a){var b=a.toJSON();this.sandbox.emit("sulu.contacts.accounts.contact.created",b)}.bind(this),error:function(){this.sandbox.logger.log("error while saving a new contact")}.bind(this)})},saveDocuments:function(b,c,d,e){a.saveDocuments(b,c,d)},processAjaxForDocuments:function(a,b,c,d){var e,f=[],g=[];a.length&&(this.sandbox.util.each(a,function(a,d){"DELETE"===c?e="/admin/api/accounts/"+b+"/medias/"+d:"POST"===c&&(e="/admin/api/accounts/"+b+"/medias"),f.push(this.sandbox.util.ajax({url:e,data:{mediaId:d},type:c}).fail(function(){this.sandbox.logger.error("Error while saving documents!")}.bind(this))),g.push(d)}.bind(this)),this.sandbox.util.when.apply(null,f).then(function(){"DELETE"===c?this.sandbox.emit("sulu.contacts.contacts.medias.removed",g):"POST"===c&&this.sandbox.emit("sulu.contacts.contacts.medias.saved",g),this.afterSaveAction(d,b,!1)}.bind(this)))},afterSaveAction:function(a,b,c){"back"==a?this.navigateToList():"new"==a?this.sandbox.emit("sulu.router.navigate","contacts/accounts/add",!0,!0):c&&this.sandbox.emit("sulu.router.navigate","contacts/accounts/edit:"+b+"/details")},bindSidebarEvents:function(){this.sandbox.dom.off("#sidebar"),this.sandbox.dom.on("#sidebar","click",function(a){var b=this.sandbox.dom.data(a.currentTarget,"id");this.sandbox.emit("sulu.contacts.accounts.load",b)}.bind(this),"#sidebar-accounts-list"),this.sandbox.dom.on("#sidebar","click",function(a){var b=this.sandbox.dom.data(a.currentTarget,"id");this.sandbox.emit("sulu.router.navigate","contacts/contacts/edit:"+b+"/details"),this.sandbox.emit("husky.navigation.select-item","contacts/contacts")}.bind(this),"#main-contact")},setMainContact:function(b){a.setMainContact(this.account.get("id"),b)},addAccountContact:function(b,c){a.addAccountContact(this.account.get("id"),b,c)},removeAccountContacts:function(b){a.removeAccountContacts(this.account.get("id"),b)},del:function(){i.showForSingle(this.sandbox,this.account,this.options.id)},save:function(b,c){this.sandbox.emit("sulu.header.toolbar.item.loading","save"),a.save(b).then(function(a){b.id&&this.sandbox.emit("sulu.contacts.accounts.saved",a),this.afterSaveAction(c,a.id,!a.id)}.bind(this))},load:function(a){this.sandbox.emit("sulu.router.navigate","contacts/accounts/edit:"+a+"/details")},loadContact:function(a){this.sandbox.emit("sulu.router.navigate","contacts/contacts/edit:"+a+"/details")},add:function(){this.sandbox.emit("sulu.router.navigate","contacts/accounts/add")},delAccounts:function(a){return a.length<1?void this.sandbox.emit("sulu.overlay.show-error","sulu.overlay.delete-no-items"):void this.showDeleteConfirmation.call(this,a)},renderList:function(){var a=this.sandbox.dom.createElement('<div id="accounts-list-container"/>');this.html(a),this.sandbox.start([{name:"accounts/list@sulucontact",options:{el:a}}])},renderEdit:function(){this.account=new b;var a=this.sandbox.dom.createElement('<div id="accounts-edit-container"/>'),c=function(b){this.sandbox.start([{name:"accounts/edit@sulucontact",options:{el:a,data:b.toJSON(),id:this.options.id}}])};this.html(a),this.options.id?(this.account=new b({id:this.options.id}),this.account.fetch({success:c.bind(this),error:function(){this.sandbox.logger.log("error while fetching contact")}.bind(this)})):c.call(this,this.account)},showDeleteConfirmation:function(a){i.showDialog(a,function(a){alert("delContacts: "+a)})}}});