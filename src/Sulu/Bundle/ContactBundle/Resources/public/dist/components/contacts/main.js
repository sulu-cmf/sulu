define(["services/sulucontact/contact-manager","services/sulucontact/contact-router","sulucontact/models/contact","sulucontact/models/title","sulucontact/models/position","sulucategory/model/category","contactsutil/delete-dialog"],function(a,b,c,d,e,f,g){"use strict";var h={datagridInstanceName:"contacts"};return{initialize:function(){if(this.bindCustomEvents(),this.bindSidebarEvents(),"edit"!==this.options.display)throw"display type wrong";this.renderEdit()},bindCustomEvents:function(){this.sandbox.on("sulu.contacts.contact.delete",this.del.bind(this)),this.sandbox.on("sulu.contacts.contacts.save",this.save.bind(this)),this.sandbox.on("sulu.contacts.contacts.load",b.toEdit.bind(this)),this.sandbox.on("sulu.contacts.contacts.new",b.toAdd.bind(this)),this.sandbox.on("sulu.contacts.contacts.delete",this.delContacts.bind(this)),this.sandbox.on("sulu.contacts.contacts.list",b.toList.bind(this)),this.sandbox.on("sulu.contacts.accounts.medias.save",this.saveDocuments.bind(this)),this.initializeDropDownListender("title-select","api/contact/titles"),this.initializeDropDownListender("position-select","api/contact/positions")},saveDocuments:function(b,c,d,e){this.sandbox.emit("sulu.header.toolbar.item.loading","save"),a.saveDocuments(b,c,d)},bindSidebarEvents:function(){this.sandbox.dom.off("#sidebar"),this.sandbox.dom.on("#sidebar","click",function(a){var b=this.sandbox.dom.data(a.currentTarget,"id");this.sandbox.emit("sulu.contacts.contacts.load",b)}.bind(this),"#sidebar-contact-list"),this.sandbox.dom.on("#sidebar","click",function(a){var b=this.sandbox.dom.data(a.currentTarget,"id");this.sandbox.emit("sulu.router.navigate","contacts/accounts/edit:"+b+"/details"),this.sandbox.emit("husky.navigation.select-item","contacts/accounts")}.bind(this),"#main-account")},del:function(){g.show(this.sandbox,this.contact)},save:function(b,c){this.sandbox.emit("sulu.header.toolbar.item.loading","save"),a.save(b).then(function(a){b.id&&this.sandbox.emit("sulu.contacts.contacts.saved",a),this.afterSaveAction(c,a.id,!b.id)}.bind(this))},afterSaveAction:function(a,b,c){"back"===a?this.sandbox.emit("sulu.contacts.contacts.list"):"new"==a?this.sandbox.emit("sulu.router.navigate","contacts/contacts/add",!0,!0):c&&this.sandbox.emit("sulu.router.navigate","contacts/contacts/edit:"+b+"/details")},delContacts:function(a){return a.length<1?void this.sandbox.emit("sulu.dialog.error.show","No contacts selected for Deletion"):void this.confirmDeleteDialog(function(b){b&&a.forEach(function(a){var b=new c({id:a});b.destroy({success:function(){this.sandbox.emit("husky.datagrid."+h.datagridInstanceName+".record.remove",a)}.bind(this)})}.bind(this))}.bind(this))},renderEdit:function(){this.contact=new c;var b=this.sandbox.dom.createElement('<div id="contacts-edit-container"/>'),d=function(a){this.sandbox.start([{name:"contacts/edit@sulucontact",options:{el:b,data:a,id:this.options.id}}])};this.html(b),this.options.id?a.loadOrNew(this.options.id).then(function(a){d.call(this,a)}.bind(this)):d.call(this,new c)},itemDeleted:function(a,b){a&&a.length>0&&this.sandbox.util.each(a,function(a,c){this.deleteItem(c,b)}.bind(this))},deleteItem:function(a,b){"title-select"===b?this.deleteEntity(d.findOrCreate({id:a}),b):"position-select"===b&&this.deleteEntity(e.findOrCreate({id:a}),b)},deleteEntity:function(a,b){a.destroy({error:function(){this.sandbox.emit("husky.select."+b+".revert")}.bind(this)})},itemSaved:function(a,b,c){a&&a.length>0&&this.sandbox.util.save(b,"PATCH",a).then(function(a){if(a.length>0){var b=a[a.length-1];this.sandbox.emit(c+".update",a,[b],!0,!0)}else this.sandbox.logger.error("No response from patch request")}.bind(this)).fail(function(a,b){this.sandbox.emit(c+".revert"),this.sandbox.logger.error(a,b)}.bind(this))},initializeDropDownListender:function(a,b){var c="husky.select."+a;this.sandbox.on(c+".delete",function(b){this.itemDeleted(b,a)}.bind(this)),this.sandbox.on(c+".save",function(a){this.itemSaved(a,b,c)}.bind(this))},confirmDeleteDialog:function(a){if(a&&"function"!=typeof a)throw"callback is not a function";this.sandbox.emit("sulu.overlay.show-warning","sulu.overlay.be-careful","sulu.overlay.delete-desc",function(){a(!1)}.bind(this),function(){a(!0)}.bind(this))}}});