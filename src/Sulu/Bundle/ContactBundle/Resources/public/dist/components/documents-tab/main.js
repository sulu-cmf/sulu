define(["services/sulucontact/account-manager","services/sulucontact/contact-manager"],function(a,b){"use strict";return{stickyToolbar:140,layout:function(){return{content:{width:"fixed"}}},templates:["/admin/contact/template/basic/documents"],initialize:function(){this.manager="contact"===this.options.type?b:a,this.data=this.options.data(),this.currentSelection=this.sandbox.util.arrayGetColumn(this.data.medias,"id"),this.bindCustomEvents(),this.render()},render:function(){this.html(this.renderTemplate(this.templates[0])),this.startSelectionOverlay(),this.initList()},bindCustomEvents:function(){this.sandbox.on("husky.datagrid.documents.number.selections",function(a){var b=a>0?"enable":"disable";this.sandbox.emit("husky.toolbar.documents.item."+b,"deleteSelected",!1)},this),this.sandbox.on("sulu.contacts."+this.options.type+".document.removed",function(a,b){this.sandbox.emit("husky.datagrid.documents.record.remove",b)}.bind(this)),this.sandbox.on("sulu.media-selection-overlay.documents.record-selected",this.addItem.bind(this)),this.sandbox.on("sulu.media-selection-overlay.documents.record-deselected",this.removeItem.bind(this))},addItem:function(a,b){this.ignoreUpdates||-1===this.currentSelection.indexOf(a)&&this.manager.addDocument(this.data.id,a).then(function(){this.sandbox.emit("husky.datagrid.documents.record.add",b),this.currentSelection.push(a)}.bind(this))},removeItem:function(a){this.ignoreUpdates||this.manager.removeDocuments(this.data.id,a).then(function(){this.currentSelection=this.sandbox.util.removeFromArray(this.currentSelection,[a])}.bind(this))},showAddOverlay:function(){this.updateOverlaySelected(),this.sandbox.emit("sulu.media-selection-overlay.documents.open")},updateOverlaySelected:function(){this.ignoreUpdates=!0,this.sandbox.emit("sulu.media-selection-overlay.documents.set-selected",this.currentSelection),this.ignoreUpdates=!1},removeSelected:function(){this.sandbox.emit("husky.datagrid.documents.items.get-selected",function(a){this.sandbox.sulu.showDeleteDialog(function(b){b&&(this.currentSelection=this.sandbox.util.removeFromArray(this.currentSelection,a),this.manager.removeDocuments(this.data.id,a))}.bind(this))}.bind(this))},initList:function(){var a=this.manager.getDocumentsData(this.data.id);this.sandbox.sulu.initListToolbarAndList.call(this,a.fieldsKey,a.fieldsUrl,{el:this.$find("#list-toolbar-container"),instanceName:"documents",template:this.getListTemplate(),hasSearch:!0},{el:this.$find("#documents-list"),url:a.listUrl,searchInstanceName:"documents",instanceName:"documents",resultKey:"media",searchFields:["name","title","description"],clickCallback:function(a,b){window.location.href=b.url},viewOptions:{table:{selectItem:{type:"checkbox"}}}})},getListTemplate:function(){return this.sandbox.sulu.buttons.get({add:{options:{callback:this.showAddOverlay.bind(this)}},deleteSelected:{options:{callback:this.removeSelected.bind(this)}}})},startSelectionOverlay:function(){var a=this.sandbox.dom.createElement("<div/>");this.sandbox.dom.append(this.$el,a),this.sandbox.start([{name:"media-selection/overlay@sulumedia",options:{el:a,instanceName:"documents",preselectedIds:this.currentSelection}}])}}});