define(["services/husky/util","services/husky/mediator","sulucontact/models/contact","sulucontact/models/title","sulucontact/models/position","sulucategory/model/category","sulumedia/models/media"],function(a,b,c,d,e,f){"use strict";function g(){}var h=null,i=function(a){var d=$.Deferred(),e=c.findOrCreate({id:a});return e.destroy({success:function(){b.emit("sulu.contacts.contact.deleted",a),b.emit("sulu.labels.success.show","contact.contacts.deleted"),d.resolve()}.bind(this),error:function(){d.reject()}.bind(this)}),d},j=function(b){var d=$.Deferred(),e=c.findOrCreate({id:b.id});return e.set(b),b.categories&&(e.get("categories").reset(),a.foreach(b.categories,function(a){a=f.findOrCreate({id:a}),e.get("categories").add(a)}.bind(this))),e.save(null,{success:function(a){d.resolve(a.toJSON())}.bind(this),error:function(a,b){d.reject(b)}.bind(this)}),d},k=function(a,c){var d=$.Deferred();return $.ajax({url:"/admin/api/contacts/"+a+"/medias/"+c,type:"DELETE",success:function(){b.emit("sulu.contacts.contact.document.removed",a,c),b.emit("sulu.labels.success.show","contact.contacts.documents-removed"),d.resolve()}.bind(this),error:function(){d.reject()}.bind(this)}),d};return g.prototype={loadOrNew:function(a){var d,e=$.Deferred();return a?(d=c.findOrCreate({id:a}),d.fetch({success:function(c){b.emit("sulu.contacts.contact.loaded",a),e.resolve(c.toJSON())}.bind(this),error:function(){e.reject()}.bind(this)})):(d=new c,b.emit("sulu.contacts.contact.created"),e.resolve(d.toJSON())),e},"delete":function(b){$.isArray(b)||(b=[b]);var c=[],d=$.Deferred();return a.each(b,function(a,b){c.push(i(b))}.bind(this)),$.when.apply(null,c).done(function(){d.resolve()}.bind(this)).fail(function(){d.reject()}.bind(this)),d},save:function(a){var c=$.Deferred();return j(a).done(function(a){b.emit("sulu.contacts.contact.saved",a.id),b.emit("sulu.labels.success.show","contact.contacts.saved"),c.resolve(a)}.bind(this)).fail(function(a){a.status&&403===a.status||b.emit("sulu.labels.error.show"),c.reject()}.bind(this)),c},saveAvatar:function(a){var c=$.Deferred();return j(a).done(function(a){b.emit("sulu.contacts.contact.avatar-saved",a.id),b.emit("sulu.labels.success.show","contact.contacts.avatar.saved"),c.resolve(a)}.bind(this)).fail(function(){b.emit("sulu.labels.error.show"),c.reject()}.bind(this)),c},deleteTitle:function(a){var c=$.Deferred(),e=d.findOrCreate({id:a});return e.destroy({success:function(){b.emit("sulu.contacts.contacts.title.deleted",a),c.resolve()}.bind(this),error:function(){c.reject()}.bind(this)}),c},saveTitles:function(c){var d=$.Deferred();return a.save("api/contact/titles","PATCH",c).done(function(a){b.emit("sulu.contacts.contacts.titles.saved"),d.resolve(a)}.bind(this)).fail(function(){d.reject()}.bind(this)),d},deletePosition:function(a){var c=$.Deferred(),d=e.findOrCreate({id:a});return d.destroy({success:function(){b.emit("sulu.contacts.contacts.position.deleted",a),c.resolve()}.bind(this),error:function(){c.reject()}.bind(this)}),c},savePositions:function(c){var d=$.Deferred();return a.save("api/contact/positions","PATCH",c).done(function(a){b.emit("sulu.contacts.contacts.positions.saved"),d.resolve(a)}.bind(this)).fail(function(){d.reject()}),d},removeDocuments:function(b,c){$.isArray(c)||(c=[c]);var d=[],e=$.Deferred();return a.each(c,function(a,c){d.push(k(b,c))}.bind(this)),$.when.apply(null,d).done(function(){e.resolve()}.bind(this)).fail(function(){e.reject()}.bind(this)),e},addDocument:function(a,c){var d=$.Deferred();return $.ajax({url:"/admin/api/contacts/"+a+"/medias",data:{mediaId:c},type:"POST",success:function(){b.emit("sulu.contacts.contact.document.added",a,c),b.emit("sulu.labels.success.show","contact.contacts.document-added"),d.resolve()}.bind(this),error:function(){d.reject()}.bind(this)}),d},setDocuments:function(a,c){var d=$.Deferred(),e=_.map(c,function(a){return{id:a}});return $.ajax({url:"/admin/api/contacts/"+a,contentType:"application/json",data:JSON.stringify({medias:e}),type:"PATCH",success:function(e){b.emit("sulu.contacts.contact.documents.saved",a,c),b.emit("sulu.labels.success.show","contact.contacts.documents-saved"),d.resolve(e)}.bind(this),error:function(){d.reject()}.bind(this)}),d},getDocumentsData:function(a){return{listUrl:"/admin/api/contacts/"+a+"/medias?flat=true",fieldsKey:"contactsDocumentsFields",fieldsUrl:"/admin/api/contacts/medias/fields"}}},g.getInstance=function(){return null===h&&(h=new g),h},g.getInstance()});